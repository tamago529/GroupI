{% extends "store_base.html" %}
{% load static %}

{% block title %}予約台帳{% endblock %}

{% block content %}
<style>
  /* ===== Layout ===== */
  .ledger-wrap{
    max-width: 1200px;
    margin: 0 auto;
    padding: 18px 14px;
  }
  .ledger-head{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom: 14px;
  }
  .ledger-title{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .ledger-title h1{
    font-size: 20px;
    margin:0;
  }
  .subline{
    font-size: 13px;
    opacity:.8;
  }

  .ledger-nav{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .btn{
    display:inline-block;
    padding: 8px 12px;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 10px;
    background: #fff;
    text-decoration:none;
    color: inherit;
    font-size: 13px;
    cursor:pointer;
  }
  .btn:hover{ background: rgba(0,0,0,.03); }

  /* ===== Messages ===== */
  .msg{
    margin: 10px 0 14px;
    padding: 10px 12px;
    border-radius: 10px;
    font-size: 13px;
  }
  .msg.success{ background: rgba(0, 180, 120, .08); border:1px solid rgba(0, 180, 120, .20); }
  .msg.error{ background: rgba(220, 60, 60, .08); border:1px solid rgba(220, 60, 60, .20); }

  /* ===== Time axis ===== */
  .time-axis{
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 5;
    padding-top: 8px;
  }
  .time-labels{
    display:grid;
    grid-template-columns: repeat({{ time_segments|default:1 }}, 1fr);
    gap:0;
    border-bottom: 1px solid rgba(0,0,0,.10);
    padding-bottom: 6px;
  }
  .time-label{
    font-size: 12px;
    opacity: .75;
    padding: 0 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ===== Lanes ===== */
  .lanes{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top: 10px;
  }
  .lane{
    border: 1px solid rgba(0,0,0,.10);
    border-radius: 14px;
    overflow: hidden;
    background:#fff;
  }
  .lane-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(0,0,0,.08);
    background: rgba(0,0,0,.02);
  }
  .lane-label{
    font-weight:600;
    font-size: 13px;
  }
  .lane-body{
    position:relative;
    height: var(--lane-h, 150px);
  }

  /* Vertical grid lines */
  .gridlines{
    position:absolute;
    inset:0;
    pointer-events:none;
    display:grid;
    grid-template-columns: repeat({{ time_segments|default:1 }}, 1fr);
  }
  .gridlines > div{
    border-left: 1px solid rgba(0,0,0,.06);
  }
  .gridlines > div:first-child{
    border-left: none;
  }

  /* ===== Closed band (中休み灰色帯) ===== */
  .closed-band{
    position:absolute;
    top:0;
    bottom:0;
    background:rgba(120,120,120,.18);
    border-left:1px solid rgba(120,120,120,.25);
    border-right:1px solid rgba(120,120,120,.25);
    pointer-events:none;
    z-index: 1;
  }

  /* ===== Reservation bar ===== */
  .bar{
    position:absolute;
    left: 0;
    top: 16px;
    height: 34px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,.12);
    background: rgba(30, 110, 255, .12);
    z-index: 2;
    overflow:hidden;
  }
  .bar a{
    display:flex;
    height: 100%;
    width: 100%;
    align-items:center;
    gap:8px;
    padding: 0 10px;
    text-decoration:none;
    color: inherit;
  }
  .bar .name{
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
    max-width: 240px;
  }
  .bar .meta{
    font-size: 11px;
    opacity: .8;
    white-space: nowrap;
  }

  /* ===== Cards for detail/edit ===== */
  .card{
    border: 1px solid rgba(0,0,0,.10);
    border-radius: 14px;
    background:#fff;
    padding: 14px;
  }
  .kv{
    display:grid;
    grid-template-columns: 150px 1fr;
    gap:10px 12px;
    font-size: 13px;
  }
  .kv .k{ opacity:.7; }

  .form-grid{
    display:grid;
    grid-template-columns: 180px 1fr;
    gap:10px 12px;
    align-items:center;
    font-size: 13px;
  }
  .input, select{
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,.16);
  }

  .help{
    font-size: 12px;
    opacity: .75;
    margin-top: 10px;
    line-height: 1.5;
  }
</style>

<div class="ledger-wrap">
  <div class="ledger-head">
    <div class="ledger-title">
      <h1>予約台帳</h1>

      {% if mode == "day" %}
        <div class="subline">
          {{ store.store_name }}（{{ store.branch_name }}） /
          {{ target_date|date:"Y-m-d" }}
          {% if day_start and day_end %}
            / 表示レンジ：{{ day_start|time:"H:i" }}〜{{ day_end|time:"H:i" }}
          {% endif %}
        </div>
      {% endif %}

      {% if mode == "detail" and reservation %}
        <div class="subline">
          {{ store.store_name }}（{{ store.branch_name }}） / 予約詳細 #{{ reservation.id }}
        </div>
      {% endif %}

      {% if mode == "edit" and reservation %}
        <div class="subline">
          {{ store.store_name }}（{{ store.branch_name }}） / 予約編集 #{{ reservation.id }}
        </div>
      {% endif %}
    </div>

    <div class="ledger-nav">
      {% if mode == "day" %}
        <a class="btn" href="{% url 'reservations_management:store_reservation_ledger_day' %}?date={{ prev_date|date:'Y-m-d' }}">← 前日</a>
        <a class="btn" href="{% url 'reservations_management:store_reservation_ledger_day' %}?date={{ next_date|date:'Y-m-d' }}">翌日 →</a>
        <a class="btn" href="{% url 'reservations_management:store_reservation_calendar' %}">カレンダー</a>
        <a class="btn" href="{% url 'reservations_management:store_reservation_settings' %}">受付設定</a>
      {% else %}
        {% if reservation %}
          <a class="btn" href="{% url 'reservations_management:store_reservation_ledger_day' %}?date={{ reservation.visit_date|date:'Y-m-d' }}">← 台帳へ戻る</a>
          <a class="btn" href="{% url 'reservations_management:store_reservation_detail' reservation.id %}">詳細</a>
          <a class="btn" href="{% url 'reservations_management:store_reservation_edit' reservation.id %}">編集</a>
        {% endif %}
      {% endif %}
    </div>
  </div>

  {# Django messages #}
  {% if messages %}
    {% for m in messages %}
      <div class="msg {% if m.tags %}{{ m.tags }}{% endif %}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  {% if mode == "day" %}
    <div class="time-axis">
      <div class="time-labels">
        {% for t in time_labels %}
          <div class="time-label">{{ t }}</div>
        {% endfor %}
      </div>
    </div>

    <div class="lanes">
      {% for lane in lanes %}
        <div class="lane">
          <div class="lane-head">
            <div class="lane-label">{{ lane.label }}</div>
            <div class="subline">
              {% if day_start and day_end %}
                営業時間表示：{{ day_start|time:"H:i" }}〜{{ day_end|time:"H:i" }}
              {% endif %}
            </div>
          </div>

          <div class="lane-body" style="--lane-h: {{ lane.height }}px;">
            <div class="gridlines" aria-hidden="true">
              {% for _ in time_labels %}
                <div></div>
              {% endfor %}
            </div>

            {# 中休み帯（灰色） #}
            {% for z in closed_bands %}
              <div class="closed-band" style="left:{{ z.left_pct }}%; width:{{ z.width_pct }}%;"></div>
            {% endfor %}

            {# bars #}
            {% for b in lane.bars %}
              <div class="bar"
                   style="left:{{ b.left_pct }}%; width:{{ b.width_pct }}%; top:{{ b.top_px }}px;">
                <a href="{% url 'reservations_management:store_reservation_detail' b.reservation_id %}">
                  <span class="name">{{ b.title }}</span>
                  <span class="meta">
                    {{ b.start|time:"H:i" }}〜{{ b.end|time:"H:i" }}
                    / {{ b.visit_count }}名
                    {% if b.course %}/ {{ b.course }}{% endif %}
                    / {{ b.status_label }}
                  </span>
                </a>
              </div>
            {% empty %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>

  {% elif mode == "detail" and reservation %}
    <div class="card">
      <div class="kv">
        <div class="k">来店日</div><div class="v">{{ reservation.visit_date|date:"Y-m-d" }}</div>
        <div class="k">開始</div><div class="v">{{ reservation.start_time|time:"H:i" }}</div>
        <div class="k">終了</div><div class="v">{{ reservation.end_time|time:"H:i" }}</div>
        <div class="k">人数</div><div class="v">{{ reservation.visit_count }} 名</div>
        <div class="k">予約者</div><div class="v">{{ reservation.booking_user.full_name }}</div>
        <div class="k">コース</div><div class="v">{{ reservation.course }}</div>
        <div class="k">ステータス</div><div class="v">{{ reservation.booking_status }}</div>
        {% if reservation.cancel_reason %}
          <div class="k">キャンセル理由</div><div class="v">{{ reservation.cancel_reason }}</div>
        {% endif %}
      </div>

      <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn" href="{% url 'reservations_management:store_reservation_edit' reservation.id %}">編集する</a>

        <form method="post" action="{% url 'reservations_management:store_reservation_action' reservation.id %}" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="action" value="visited">
          <button class="btn" type="submit">来店済みにする</button>
        </form>

        <form method="post" action="{% url 'reservations_management:store_reservation_action' reservation.id %}" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="action" value="cancel">
          <button class="btn" type="submit">キャンセルにする</button>
        </form>
      </div>
    </div>

  {% elif mode == "edit" and reservation %}
    <div class="card">
      <form method="post" action="{% url 'reservations_management:store_reservation_edit' reservation.id %}">
        {% csrf_token %}

        <div class="form-grid">
          <div>来店日</div>
          <div>
            <input class="input" type="date" name="visit_date" value="{{ reservation.visit_date|date:'Y-m-d' }}">
          </div>

          <div>開始時刻</div>
          <div>
            <input class="input" id="startTimeInput" type="time" name="start_time" value="{{ reservation.start_time|time:'H:i' }}">
          </div>

          <div>コース</div>
          <div>
            {# ★コース（30/60/90/120/150） #}
            <select id="courseSelect" name="course_minutes">
              <option value="">（変更しない）</option>
              <option value="30">30分</option>
              <option value="60">1時間</option>
              <option value="90">1時間30分</option>
              <option value="120">2時間</option>
              <option value="150">2時間30分</option>
            </select>
            <div class="help">
              ※コースを選ぶと「終了時刻」を自動計算します（手入力で上書きもOK）
            </div>
          </div>

          <div>終了時刻</div>
          <div>
            <input class="input" id="endTimeInput" type="time" name="end_time" value="{{ reservation.end_time|time:'H:i' }}">
          </div>

          <div>人数</div>
          <div>
            <input class="input" type="number" name="visit_count" min="1" value="{{ reservation.visit_count }}">
          </div>

          <div>ステータス</div>
          <div>
            <select name="booking_status_id">
              <option value="">（変更しない）</option>
              {% for s in status_choices %}
                <option value="{{ s.id }}" {% if reservation.booking_status.id == s.id %}selected{% endif %}>
                  {{ s.status }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="help">
          ※ 営業時間外 / 中休み跨ぎは保存できません（views側でチェック済み）
        </div>

        <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" type="submit">保存</button>
          <a class="btn" href="{% url 'reservations_management:store_reservation_detail' reservation.id %}">キャンセル</a>
        </div>
      </form>
    </div>

    <script>
      // コース(min) → 終了時刻 自動計算
      function parseTimeToMinutes(hm){
        if(!hm) return null;
        const [h,m] = hm.split(":").map(Number);
        if(Number.isNaN(h) || Number.isNaN(m)) return null;
        return h*60 + m;
      }
      function minutesToTimeStr(min){
        min = Math.max(0, Math.min(23*60 + 59, min));
        const h = String(Math.floor(min/60)).padStart(2,"0");
        const m = String(min%60).padStart(2,"0");
        return `${h}:${m}`;
      }

      const courseSel = document.getElementById("courseSelect");
      const startEl = document.getElementById("startTimeInput");
      const endEl = document.getElementById("endTimeInput");

      function autoCalcEnd(){
        const c = Number(courseSel.value);
        if(!c) return; // 変更しない
        const sMin = parseTimeToMinutes(startEl.value);
        if(sMin === null) return;
        const eMin = sMin + c;
        // 日跨ぎは views 側で弾く想定。UIはとりあえず 23:59 で丸めない
        endEl.value = minutesToTimeStr(Math.min(eMin, 23*60 + 59));
      }

      courseSel.addEventListener("change", autoCalcEnd);
      startEl.addEventListener("change", autoCalcEnd);
    </script>

  {% else %}
    <div class="card">
      表示モードが不正です。
    </div>
  {% endif %}
</div>
{% endblock %}
