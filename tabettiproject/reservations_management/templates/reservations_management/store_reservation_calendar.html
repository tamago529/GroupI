{% extends "store_base.html" %}
{% load dict_extras %}
{% block title %}店舗管理予約カレンダー{% endblock %}

{% block content %}

<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --line:#d9dde3;
  --text:#222;
  --muted:#6b7280;
  --brand:#ff8a00;
  --nav:#2f343a;
  --link:#1a73e8;

  --danger-bg:#ffe9e7;
  --danger-line:#f3b6b0;
  --danger-text:#b42318;

  --cal-head:#f7f7f7;
  --cal-sat:#1a73e8;
  --cal-sun:#d14343;
  --cal-today:#fff7cc;
  --cal-closed:#fdecec;
}

*{box-sizing:border-box}
a{color:var(--link);text-decoration:none}
a:hover{text-decoration:underline}

.cal-wrap{max-width:1200px;margin:0 auto;padding:10px 12px 24px;color:var(--text);}

.cal-head{margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
.cal-month{font-size:16px; font-weight:900;}
.cal-nav{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
.cal-btn{
  border:1px solid var(--line); background:#fff; padding:7px 10px; border-radius:6px;
  cursor:pointer; font-weight:900; font-size:12px; color:#333;
}
.cal-btn:hover{background:#f3f4f6}

.cal-card{margin-top:10px; border:1px solid var(--line); border-radius:6px; overflow:hidden; background:#fff;}
.cal-weekdays{display:grid; grid-template-columns:repeat(7,1fr); background:var(--cal-head); border-bottom:1px solid var(--line);}
.cal-weekdays div{padding:10px 8px; font-size:12px; font-weight:900; text-align:center; color:#333;}
.cal-weekdays .sat{color:var(--cal-sat)}
.cal-weekdays .sun{color:var(--cal-sun)}

.cal-grid{display:grid; grid-template-columns:repeat(7,1fr);}
.cal-cell{
  min-height:92px; border-right:1px solid var(--line); border-bottom:1px solid var(--line);
  padding:8px 8px 10px; background:#fff; position:relative;
}
.cal-cell:nth-child(7n){border-right:none}

.cal-day{display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; font-weight:900; margin-bottom:6px;}
.cal-day .num{font-variant-numeric:tabular-nums;}
.cal-badge{
  font-size:10px; font-weight:900; padding:2px 6px; border-radius:999px; border:1px solid #e5e7eb;
  background:#fff; color:#333;
}

.cal-cell.sat .cal-day{color:var(--cal-sat)}
.cal-cell.sun .cal-day{color:var(--cal-sun)}
.cal-cell.other{background:#f3f4f6;color:#9aa0a6;}
.cal-cell.other .cal-day{color:#9aa0a6}
.cal-cell.closed{background:var(--cal-closed);}
.cal-cell.closed .cal-badge{border-color:var(--danger-line); color:var(--danger-text);}
.cal-cell.today{background:var(--cal-today);}

.cal-chip{
  border-radius:6px; padding:6px 8px; font-size:11px; font-weight:900;
  background:#eef2f7; border:1px solid #e5e7eb; color:#333;
}
.cal-chip.zero{opacity:.55}

.cal-sub{
  margin-top:6px;
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:wrap;
  font-size:10px;
  color:var(--muted);
  font-weight:800;
}

.cal-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  border:1px solid #e5e7eb;
  background:#fff;
  padding:3px 8px;
  border-radius:999px;
}

.cal-dot{
  width:8px;height:8px;border-radius:50%;
  background:#9ca3af;
}
.cal-dot.ok{background:#2e7d32;}
.cal-dot.ng{background:#c62828;}

@media (max-width: 680px){
  .cal-cell{min-height:78px;padding:7px 6px}
  .cal-chip{font-size:10px}
}
</style>



<div class="cal-wrap">

  <div class="cal-head">
    <div class="cal-month">{{ month_label }}</div>

    <div class="cal-nav">
      {% url 'reservations_management:store_reservation_calendar' as url_cal %}
      <a class="cal-btn"
         href="{% if url_cal %}{{ url_cal }}?year={{ today.year }}&month={{ today.month }}{% else %}#{% endif %}">
        今月
      </a>
      <a class="cal-btn"
         href="{% if url_cal %}{{ url_cal }}?year={{ prev_year }}&month={{ prev_month }}{% else %}#{% endif %}">
        ‹
      </a>
      <a class="cal-btn"
         href="{% if url_cal %}{{ url_cal }}?year={{ next_year }}&month={{ next_month }}{% else %}#{% endif %}">
        ›
      </a>
    </div>
  </div>

  <section class="cal-card">
    <div class="cal-weekdays">
      <div>月 (Mon)</div>
      <div>火 (Tue)</div>
      <div>水 (Wed)</div>
      <div>木 (Thu)</div>
      <div>金 (Fri)</div>
      <div class="sat">土 (Sat)</div>
      <div class="sun">日 (Sun)</div>
    </div>

    <div class="cal-grid">
      {% for week in weeks %}
        {% for d in week %}
          {% with info=daily|get_item:d %}
          {% with o=online|get_item:d %}

            {# 週内の曜日インデックス：0(月) ... 5(土) 6(日) #}
            {% with wd=forloop.counter0 %}
            <div class="cal-cell
                        {% if wd == 5 %}sat{% endif %}
                        {% if wd == 6 %}sun{% endif %}
                        {% if d.month != month %}other{% endif %}
                        {% if d == today %}today{% endif %}
                        {% if d in closed_days %}closed{% endif %}">

              <div class="cal-day">
                <span class="num">{{ d.day }}</span>
                {% if d in closed_days %}
                  <span class="cal-badge">休業日</span>
                {% endif %}
              </div>

              {% if info %}
                <div class="cal-chip">予約：{{ info.groups }}組（{{ info.people }}名）</div>
              {% else %}
                <div class="cal-chip zero">予約：0組（0名）</div>
              {% endif %}

              <div class="cal-sub">
                {% if o %}
                  {% if o.is_open %}
                    <span class="cal-pill"><span class="cal-dot ok"></span>受付中</span>
                  {% else %}
                    <span class="cal-pill"><span class="cal-dot ng"></span>停止中</span>
                  {% endif %}
                  <span class="cal-pill">空き：{{ o.available_seats }}席</span>
                {% else %}
                  <span class="cal-pill"><span class="cal-dot"></span>未設定</span>
                {% endif %}
              </div>

            </div>
            {% endwith %}

          {% endwith %}
          {% endwith %}
        {% endfor %}
      {% endfor %}
    </div>

  </section>

</div>

{% endblock %}
