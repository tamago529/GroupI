{% extends "store_base.html" %}
{% load static %}

{% block title %}店舗トップ{% endblock %}

{% block css %}
<style>
  *, *::before, *::after {
    box-sizing: border-box;
  }

  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --line:#d9dde3;
    --text:#222;
    --muted:#6b7280;
    --brand:#ff8a00;
    --nav:#2f343a;
    --nav2:#3a4047;
    --link:#1a73e8;
    --ok:#2e7d32;
  }

  .wrap{max-width:1200px; margin:0 auto; padding:10px 12px 24px;}
  a{color:var(--link); text-decoration:none;}

  .topbar{
    background:#fff;
    border:1px solid var(--line);
    border-radius:6px;
    overflow:hidden;
  }

  .layout{
    padding:12px;
    display:grid;
    grid-template-columns: 230px 1fr 260px;
    gap:10px;
    align-items:start;
  }
  @media (max-width: 1100px){
    .layout{grid-template-columns: 230px 1fr;}
    .right{display:none;}
  }
  @media (max-width: 780px){
    .layout{grid-template-columns:1fr;}
    .sidebar{order:2;}
    .right{display:block;}
  }

  /* sidebar */
  .sidebar{
    background:var(--nav);
    color:#fff;
    border-radius:6px;
    overflow:hidden;
    border:1px solid #1f2327;
  }
  .side-head{
    padding:12px 12px;
    font-weight:900;
    background:#1f2327;
    border-bottom:1px solid #1b1f23;
  }
  .menu{
    list-style:none;
    margin:0;
    padding:6px 0;
  }
  .menu li a{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    color:#fff;
    font-size:13px;
    border-left:4px solid transparent;
  }
  .menu li a:hover{background:var(--nav2);}
  .menu li.active a{
    background:var(--nav2);
    border-left-color:var(--brand);
    font-weight:900;
  }
  .side-note{
    background:#fff;
    border-radius:6px;
    border:1px solid var(--line);
    margin:10px;
    padding:12px;
    font-size:12px;
    color:var(--muted);
    line-height:1.6;
  }

  /* cards */
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:6px;
    overflow:hidden;
  }
  .card + .card{margin-top:10px;}
  .card-h{
    padding:10px 12px;
    font-weight:900;
    border-bottom:1px solid var(--line);
    background:#f7f7f7;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .card-h small{font-weight:700; color:var(--muted);}
  .card-b{padding:12px;}

  .notice-list{
    list-style:none;
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    gap:8px;
    font-size:13px;
  }
  .notice-item{
    display:flex;
    gap:10px;
    align-items:center;
    padding:8px 10px;
    border:1px solid #eee;
    border-radius:6px;
    background:#fff;
  }
  .tag-new{
    font-size:11px;
    background:#ffefc7;
    border:1px solid #ffd27a;
    color:#9a5a00;
    font-weight:900;
    padding:2px 6px;
    border-radius:4px;
  }
  .date{font-size:12px;color:var(--muted); min-width:88px;}

  .chart{
    height:210px;
    border:1px solid #e5e7eb;
    border-radius:6px;
    background:linear-gradient(180deg,#ffffff,#f9fafb);
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--muted);
    font-weight:900;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th,td{
    border-top:1px solid #eee;
    padding:10px 8px;
    text-align:left;
  }
  th{background:#fafafa; font-weight:900;}
  td.num{text-align:right; font-variant-numeric: tabular-nums;}

  /* right */
  .right .card-b{padding:10px 12px;}
  .status{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:12px;
    color:var(--muted);
    margin-bottom:10px;
  }
  .dot{
    width:10px;height:10px;border-radius:50%;
    background:var(--ok);
    box-shadow:0 0 0 4px rgba(46,125,50,.15);
  }
  .btn{
    display:block;
    width:100%;
    border:none;
    border-radius:6px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
    background:#2563eb;
    color:#fff;
    margin-bottom:10px;
    text-align:center;
  }
  .btn.gray{background:#6b7280;}

  .mini-list{
    list-style:none;
    margin:0;
    padding:0;
    font-size:12px;
    color:#333;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .mini-list li{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:8px 10px;
    border:1px solid #eee;
    border-radius:6px;
    background:#fff;
  }
  .muted{color:var(--muted);}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="topbar">
    <div class="layout">

      <!-- left sidebar -->
      <aside class="sidebar">
        <div class="side-head">メニュー</div>
        <ul class="menu">
          <li class="active">
            <a href="{% url 'stores:store_top' %}"><span>トップ</span><span>›</span></a>
          </li>
          <li><a href="{% url 'reservations_management:store_reservation_calendar' %}"><span>予約カレンダー</span><span>›</span></a></li>
          <li><a href="{% url 'reservations_management:store_reservation_ledger' %}"><span>予約台帳</span><span>›</span></a></li>
          <li><a href="{% url 'reservations_management:store_customer_ledger' %}"><span>顧客台帳</span><span>›</span></a></li>
          <li><a href="{% url 'reservations_management:store_reservation_settings' %}"><span>ネット予約受付設定</span><span>›</span></a></li>
          <li><a href="{% url 'reservations_management:store_seat_settings' %}"><span>席設定</span><span>›</span></a></li>
          <li><a href="#"><span>店舗情報の設定</span><span>›</span></a></li>
          <li><a href="#"><span>広告・ページ管理</span><span>›</span></a></li>
          <li><a href="#"><span>レポート</span><span>›</span></a></li>
          <li><a href="{% url 'reviews:store_review_list' store.pk %}"><span>口コミ</span><span>›</span></a></li>
          <li><a href="#"><span>求人管理</span><span>›</span></a></li>
          <li><a href="#"><span>プラン・契約</span><span>›</span></a></li>
        </ul>

        <div class="side-note">
          <strong>店舗：</strong>{{ store.store_name }}{% if store.branch_name %}（{{ store.branch_name }}）{% endif %}<br/>
          <span class="muted">このページは store_base.html の中で表示されています。</span>
        </div>
      </aside>

      <!-- center -->
      <main>
        <section class="card">
          <div class="card-h">
            <div>タベッチからのお知らせ</div>
            <a href="#"><small>一覧を見る</small></a>
          </div>
          <div class="card-b">
            <ul class="notice-list">
              <li class="notice-item">
                <div class="date">2026/01/20</div>
                <div class="tag-new">NEW</div>
                <div><a href="#">店舗管理機能の更新のお知らせ</a></div>
              </li>
              <li class="notice-item">
                <div class="date">2026/01/19</div>
                <div class="tag-new">NEW</div>
                <div><a href="#">ネット予約管理が利用できるようになりました</a></div>
              </li>
            </ul>
          </div>
        </section>

        <section class="card">
          <div class="card-h">
            <div>過去7日間のアクセス数（PV）</div>
            <a href="#"><small>詳細データを見る</small></a>
          </div>
          <div class="card-b">
            <div class="chart-container" style="position: relative; height:210px; width:100%">
              <canvas id="accessChart"></canvas>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-h">
            <div>来店情報</div>
            <a href="#"><small>詳細データを見る</small></a>
          </div>
          <div class="card-b">
            <table>
              <thead>
                <tr>
                  <th>項目</th>
                  <th class="num">今日</th>
                  <th class="num">今月</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>本日の予約数</td>
                  <td class="num">{{ today_reservations_count }}</td>
                  <td class="num">{{ month_reservations_count }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>

      <!-- right -->
      <aside class="right">
        <section class="card">
          <div class="card-h">ネット予約</div>
          <div class="card-b">
            <div class="status">
              {% if is_online_open %}
                <span class="dot"></span><span>受付中です</span>
              {% else %}
                <span class="dot" style="background:#9ca3af; box-shadow:none;"></span>
                <span style="color:#6b7280;">現在 停止中</span>
              {% endif %}
            </div>

            <a class="btn" href="{% url 'reservations_management:store_reservation_ledger' %}">
              ネット予約管理画面へ
            </a>
            <a class="btn gray" href="{% url 'reservations_management:store_reservation_settings' %}">
              予約受付設定を見る
            </a>
          </div>
        </section>

        <section class="card">
          <div class="card-h">本日のご予約</div>
          <div class="card-b">
            <ul class="mini-list">
              {% for r in today_reservations %}
                <li>
                  <span>
                    {% if r.start_time %}
                      {{ r.start_time|time:"H:i" }}〜{{ r.end_time|time:"H:i" }}
                    {% else %}
                      {{ r.visit_time|time:"H:i" }}〜
                    {% endif %}
                  </span>
                  <span class="muted">{{ r.visit_count }}名</span>
                </li>
              {% empty %}
                <li><span>本日の予約はありません</span><span class="muted">-</span></li>
              {% endfor %}
            </ul>
          </div>
        </section>

        <section class="card">
          <div class="card-h">新着予約情報</div>
          <div class="card-b">
            <ul class="mini-list">
              <li><span>新規予約</span><span class="muted">（後で実装）</span></li>
              <li><span>予約内容変更</span><span class="muted">（後で実装）</span></li>
              <li><span>予約キャンセル</span><span class="muted">（後で実装）</span></li>
            </ul>
          </div>
        </section>
      </aside>

    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('accessChart').getContext('2d');
    const labels = {{ chart_labels|safe|default:"[]" }};
    const data = {{ chart_data|safe|default:"[]" }};

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'アクセス数 (PV)',
          data: data,
          borderColor: '#ff8a00',
          backgroundColor: 'rgba(255, 138, 0, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: '#ff8a00'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        }
      }
    });
  });
</script>
{% endblock %}
