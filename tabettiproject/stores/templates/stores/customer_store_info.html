{% extends "customer_base.html" %}

{% block title %}{{ store.store_name }} - 店舗情報{% endblock %}

{% block css %}
<style>
  .shop-main {
    max-width: 1000px;
    margin: 0 auto;
    background: #fff;
    border: 1px solid #e6e6e6;
    color: #333;
    font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
  }

  .back-nav { padding: 10px 20px; background: #f4f4f2; border-bottom: 1px solid #e6e6e6; }
  .back-link { font-size: 12px; color: #06c; text-decoration: none; }

  .shop-header { padding: 20px 20px 0 20px; }
  .shop-name { display: inline; font-size: 24px; font-weight: bold; }

  .score-container { display:flex; align-items: baseline; margin-top:10px; gap:12px; }
  .score-number { font-size:24px; font-weight:bold; color:#e44d26; }

  .tab-menu { display:flex; list-style:none; padding:0; margin:20px 0 0; border-bottom:2px solid #9c8e71; }
  .tab-menu li { padding:8px 16px; border:1px solid #e6e6e6; border-bottom:none; margin-right:2px; font-size:14px; font-weight:bold; background:#fff; }
  .tab-menu li a { text-decoration:none; color:#333; }
  .tab-menu li.active { background:#9c8e71; color:#fff; border-color:#9c8e71; }

  .flex-body { display:flex; padding:20px; gap:20px; }
  .left-content { width:650px; }
  .right-sidebar { width:300px; }

  /* 店舗画像 */
  .photo-preview { display:flex; gap:5px; margin-bottom:20px; flex-wrap:wrap; }
  .photo-preview img { width:125px; height:125px; object-fit:cover; border:1px solid #eee; border-radius:6px; }

  .info-title { font-size:18px; border-left:4px solid #9c8e71; padding-left:10px; margin:30px 0 15px; }
  .detail-table { width:100%; border-collapse:collapse; font-size:13px; border-top:2px solid #eee; }
  .detail-table th { width:180px; background:#fafaf8; border:1px solid #e6e6e6; padding:12px; text-align:left; }
  .detail-table td { border:1px solid #e6e6e6; padding:12px; }

  .footer-links { margin-top:20px; padding-top:15px; border-top:1px solid #eee; font-size:12px; }
  .footer-links a { color:#06c; margin-right:15px; text-decoration:none; }

  /* 右：カード */
  .side-box { border:1px solid #e6e6e6; padding:15px; margin-bottom:20px; border-radius:10px; }
  .btn-primary {
    display:block; width:100%;
    background:#00a0e9; color:#fff;
    padding:12px; font-size:16px; font-weight:bold;
    border-radius:6px; border:none; cursor:pointer;
  }
  .btn-ghost {
    display:inline-block;
    background:#fff; color:#333;
    padding:10px 12px; font-weight:bold;
    border-radius:6px; border:1px solid #ddd; cursor:pointer;
  }

  /* 予約カレンダー */
  .cal-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; }
  .cal-ym { font-weight:bold; }
  .cal-nav { display:flex; gap:6px; }
  .cal-btn { border:1px solid #ddd; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; }

  .cal-grid {
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:6px;
    font-size:12px;
  }
  .cal-dow { text-align:center; color:#777; padding:6px 0; }
  .cal-cell {
    text-align:center;
    padding:10px 0;
    border:1px solid #eee;
    border-radius:8px;
    cursor:pointer;
    user-select:none;
  }
  .cal-cell.is-empty { border:none; cursor:default; }
  .cal-cell.is-open { border-color:#ff8c00; position:relative; }
  .cal-cell.is-open::after{
    content:"○";
    position:absolute;
    right:6px; bottom:4px;
    font-size:12px;
    color:#ff8c00;
    font-weight:bold;
  }
  .cal-cell.is-disabled { color:#bbb; cursor:not-allowed; background:#fafafa; }

  .reserve-panel { margin-top:12px; border-top:1px solid #eee; padding-top:12px; display:none; }
  .rp-row { display:flex; gap:8px; margin-bottom:10px; }
  .rp-row select, .rp-row input {
    width:100%;
    padding:10px;
    border:1px solid #ddd;
    border-radius:8px;
  }
  .rp-note { font-size:12px; color:#666; margin-top:6px; }

  /* モーダル */
  .modal-overlay{
    display:none;
    position:fixed; inset:0;
    background:rgba(0,0,0,0.6);
    z-index:1000;
    align-items:center;
    justify-content:center;
  }
  .modal-box{
    background:#fff;
    width:520px;
    max-width:92vw;
    padding:22px;
    border-radius:12px;
    position:relative;
  }
  .modal-close{
    position:absolute;
    top:10px; right:14px;
    font-size:22px;
    cursor:pointer;
    color:#999;
  }
  .modal-title{ font-size:18px; font-weight:bold; margin:0 0 8px; }
  .modal-sub{ font-size:13px; color:#666; margin:0 0 14px; }
  .m-row{ display:flex; gap:10px; margin-bottom:10px; }
  .m-row input, .m-row textarea, .m-row select{
    width:100%;
    padding:10px;
    border:1px solid #ddd;
    border-radius:8px;
  }
  .m-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
</style>
{% endblock %}

{% block content %}
<div class="shop-main">

  <nav class="back-nav">
    <a href="{% url 'accounts:customer_top' %}" class="back-link">« 検索結果へ戻る</a>
  </nav>

  <header class="shop-header">
    <h1 class="shop-name">{{ store.store_name }} {{ store.branch_name }}</h1>

    <div class="score-container">
      <span class="stars">★★★☆☆</span>
      <span class="score-number">3.00</span>
      <a href="{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}"
         style="color:#06c; font-size:12px; text-decoration:none;">口コミを表示</a>
    </div>

    <nav>
      <ul class="tab-menu">
        <li class="active">トップ</li>
        <li><a href="{% url 'stores:customer_menu_course' store.pk %}">メニュー・コース</a></li>
        <li>写真</li>
        <li><a href="{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}">口コミ</a></li>
        <li><a href="{% url 'stores:customer_map' %}">地図</a></li>
      </ul>
    </nav>
  </header>

  <div class="flex-body">

    <main class="left-content">
      <section class="photo-preview">
        {% for img in store_images|slice:":5" %}
          {% if img.image_file %}
            <img src="{{ img.image_file.url }}" alt="{{ store.store_name }} 画像">
          {% endif %}
        {% endfor %}
      </section>

      <section>
        <h2 class="info-title">店舗情報（詳細）</h2>
        <table class="detail-table">
          <tbody>
            <tr>
              <th scope="row">店名</th>
              <td>{{ store.store_name }} {{ store.branch_name }}</td>
            </tr>
            <tr>
              <th scope="row">地図</th>
              <td><a href="{% url 'stores:customer_map' %}" style="color:#06c; text-decoration:none;">地図を見る</a></td>
            </tr>
            <tr>
              <th scope="row">ジャンル</th>
              <td>{{ store.scene.scene_name }}</td>
            </tr>
            <tr>
              <th scope="row">住所</th>
              <td>{{ store.address }}</td>
            </tr>
            <tr>
              <th scope="row">営業時間</th>
              <td>{{ store.business_hours|linebreaksbr }}</td>
            </tr>
            <tr>
              <th scope="row">支払い方法</th>
              <td>店舗にご確認ください。</td>
            </tr>
          </tbody>
        </table>

        <div class="footer-links">
          <a href="{% url 'stores:store_basic_edit' %}">店舗基本情報編集</a>
          <a href="{% url 'reviews:customer_report_input' %}">店舗の誤りなどを報告する</a>
        </div>
      </section>
    </main>

    <aside class="right-sidebar">
      <div class="side-box">
        <p style="text-align:center; color:#666; font-size:11px; margin:0;">お問い合わせ番号</p>
        <p style="text-align:center; font-size:22px; font-weight:bold; margin:5px 0;">
          {{ store.phone_number }}
        </p>

        <div style="margin-top:12px;">
          <div class="cal-head">
            <div class="cal-nav">
              <button type="button" class="cal-btn" onclick="moveMonth(-1)">◀</button>
              <button type="button" class="cal-btn" onclick="moveMonth(1)">▶</button>
            </div>
            <div class="cal-ym" id="calYmText">{{ cal_year }}年 {{ cal_month }}月</div>
          </div>

          <div class="cal-grid" id="calGrid">
            <div class="cal-dow">日</div><div class="cal-dow">月</div><div class="cal-dow">火</div>
            <div class="cal-dow">水</div><div class="cal-dow">木</div><div class="cal-dow">金</div><div class="cal-dow">土</div>
          </div>

          <div class="reserve-panel" id="reservePanel">
            <div style="font-weight:bold; margin-bottom:8px;">
              選択日：<span id="pickedDateText">-</span>
            </div>

            <div class="rp-row">
              <!-- ★ 今日の場合だけ min をセットする（JSで制御） -->
              <input id="pickedTime" type="time" value="19:00">
            </div>

            <div class="rp-row">
              <select id="pickedCount">
                <option value="1">1名</option>
                <option value="2" selected>2名</option>
                <option value="3">3名</option>
                <option value="4">4名</option>
                <option value="5">5名</option>
                <option value="6">6名</option>
                <option value="7">7名</option>
                <option value="8">8名</option>
                <option value="9">9名</option>
                <option value="10">10名</option>
              </select>
              <select id="pickedCourse">

                <option value="30">30分コース</option>
                <option value="60">1時間コース</option>
                <option value="90">1時間30分コース</option>
                <option value="120" selected>2時間コース</option>
                <option value="150">2時間30分コース</option>

              </select>
            </div>

            <button type="button" class="btn-primary" onclick="openReserveModal()">
              空席確認・予約する
            </button>
            <div class="rp-note">○の日付のみ予約できます（簡易版：日単位）。</div>
          </div>

        </div>
      </div>

      <div class="side-box">
        <p style="font-size:14px; font-weight:bold; margin:0;">メニュー・コース</p>
        <p style="font-size:12px; margin-top:10px;">
          <a href="{% url 'stores:customer_menu_course' store.pk %}" style="color:#06c; text-decoration:none;">
            メニュー・コースを見る
          </a>
        </p>
      </div>
    </aside>

  </div>
</div>

<!-- モーダル -->
<div class="modal-overlay" id="reserveModal" onclick="closeReserveModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="modal-close" onclick="closeReserveModal()">&times;</span>

    <div class="modal-title">予約情報の入力</div>
    <div class="modal-sub" id="modalSubText">-</div>

    <form method="post" action="{% url 'stores:customer_reserve_create' store.id %}">
      {% csrf_token %}

      <input type="hidden" name="visit_date" id="f_visit_date">
      <input type="hidden" name="visit_time" id="f_visit_time">
      <input type="hidden" name="visit_count" id="f_visit_count">
      <input type="hidden" name="course_minutes" id="f_course_minutes">

      <div class="m-row">
        <input name="full_name" placeholder="氏名"
          value="{% if login_customer %}{{ login_customer.nickname }}{% endif %}">
        <input name="full_name_kana" placeholder="氏名かな" value="">
      </div>

      <div class="m-row">
        <input name="phone_number" placeholder="電話番号"
          value="{% if login_customer %}{{ login_customer.phone_number }}{% endif %}">
        <input name="email" type="email" placeholder="メールアドレス"
          value="{% if login_customer %}{{ login_customer.sub_email }}{% endif %}">
      </div>

      <div class="m-row">
        <textarea name="note" placeholder="お店へのご要望（任意）"></textarea>
      </div>

      <div class="m-actions">
        <button type="button" class="btn-ghost" onclick="closeReserveModal()">戻る</button>
        <button type="submit" class="btn-primary" style="width:auto; padding:10px 16px;">予約する</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ---- 初期値（Djangoから） ----
  const STORE_ID = {{ store.id }};
  let calYear = {{ cal_year }};
  let calMonth = {{ cal_month }};
  let openDays = new Set({{ open_days|safe }}); // ["YYYY-MM-DD", ...]

  // ★ 今日・現在時刻（サーバのローカル時間）
  const TODAY_STR = "{{ today|date:'Y-m-d' }}";     // 例: "2026-01-23"
  const NOW_HM = "{{ now_hm }}";                   // 例: "11:35"（viewで渡す）

  const todayDate = new Date(TODAY_STR + "T00:00:00");
  const nowDateTime = new Date(TODAY_STR + "T" + NOW_HM + ":00");

  let pickedDate = null;

  function ymString(y, m){
    const mm = String(m).padStart(2, "0");
    return `${y}-${mm}`;
  }
  function isoDate(y, m, d){
    const mm = String(m).padStart(2, "0");
    const dd = String(d).padStart(2, "0");
    return `${y}-${mm}-${dd}`;
  }
  function parseIsoDate(iso){
    return new Date(iso + "T00:00:00");
  }

  // ---- カレンダー描画 ----
  function renderCalendar(){
    document.getElementById("calYmText").textContent = `${calYear}年 ${calMonth}月`;

    const grid = document.getElementById("calGrid");

    // 曜日ヘッダ（7個）は残して、以降を全削除
    while (grid.children.length > 7) grid.removeChild(grid.lastChild);

    const first = new Date(calYear, calMonth - 1, 1);
    const startDow = first.getDay(); // 0=Sun
    const lastDay = new Date(calYear, calMonth, 0).getDate();

    // 空セル
    for(let i=0;i<startDow;i++){
      const cell = document.createElement("div");
      cell.className = "cal-cell is-empty";
      grid.appendChild(cell);
    }

    for(let d=1; d<=lastDay; d++){
      const cell = document.createElement("div");
      const iso = isoDate(calYear, calMonth, d);
      const cellDate = parseIsoDate(iso);

      cell.className = "cal-cell";
      cell.textContent = d;

      // ★ 昨日以前（今日より前）は触れない
      if (cellDate < todayDate){
        cell.classList.add("is-disabled");
        cell.style.pointerEvents = "none";
        grid.appendChild(cell);
        continue;
      }

      // 今日以降は openDays だけ○
      if(openDays.has(iso)){
        cell.classList.add("is-open");
        cell.addEventListener("click", () => pickDate(iso));
      }else{
        cell.classList.add("is-disabled");
        cell.style.pointerEvents = "none";
      }

      grid.appendChild(cell);
    }
  }

  function pickDate(iso){
    // ★ 念のため：過去日クリック不可
    if (parseIsoDate(iso) < todayDate) return;

    pickedDate = iso;
    document.getElementById("reservePanel").style.display = "block";
    document.getElementById("pickedDateText").textContent = iso;

    // ★ 今日なら time を「いま以降」に制限
    const timeEl = document.getElementById("pickedTime");
    if (pickedDate === TODAY_STR){
      timeEl.min = NOW_HM;

      // 選択中が過去なら、現在時刻に寄せる（分の端数で min を超えないように）
      if (timeEl.value && timeEl.value < NOW_HM){
        timeEl.value = NOW_HM;
      }
    } else {
      timeEl.min = ""; // 今日以外は解除
    }
  }

  // ---- 月移動：サーバからopen_daysを取得 ----
  async function moveMonth(delta){
    calMonth += delta;
    if(calMonth <= 0){ calMonth = 12; calYear -= 1; }
    if(calMonth >= 13){ calMonth = 1; calYear += 1; }

    pickedDate = null;
    document.getElementById("reservePanel").style.display = "none";

    const ym = ymString(calYear, calMonth);
    const url = "{% url 'stores:availability_json' 0 %}".replace("/0/", `/${STORE_ID}/`) + `?ym=${ym}`;

    const res = await fetch(url);
    const data = await res.json();

    openDays = new Set(data.open_days);
    calYear = data.year;
    calMonth = data.month;

    renderCalendar();
  }

  // ---- モーダル ----
  function openReserveModal(){
    if(!pickedDate) return;

    const t = document.getElementById("pickedTime").value || "19:00";

    // ★ 今日＆現在時刻より前ならNG（最終防衛）
    if (pickedDate === TODAY_STR && t < NOW_HM){
      alert("現在時刻より前は予約できません。");
      document.getElementById("pickedTime").value = NOW_HM;
      return;
    }
    // ★ 念のため：過去日ならNG
    if (parseIsoDate(pickedDate) < todayDate){
      alert("過去の日付は予約できません。");
      return;
    }

const p = document.getElementById("pickedCount").value || "2";
const c = document.getElementById("pickedCourse").value || "120";

document.getElementById("f_visit_date").value = pickedDate;
document.getElementById("f_visit_time").value = t;
document.getElementById("f_visit_count").value = p;
document.getElementById("f_course_minutes").value = c;

// 30分刻み〜150分（2時間30分）まで対応：表示は「○○分コース」に統一
const courseText = `${c}分コース`;

document.getElementById("modalSubText").textContent =
  `${pickedDate} ${t} / ${p}名 / ${courseText}`;

document.getElementById("reserveModal").style.display = "flex";
}
function closeReserveModal(){
  document.getElementById("reserveModal").style.display = "none";
}


  // 初期描画
  renderCalendar();
</script>
{% endblock %}
