{% extends "customer_base.html" %}

{% block title %}{{ store.store_name }} - åº—èˆ—æƒ…å ±{% endblock %}

{% block css %}
<style>
  /* =========================================
     1. å…¨ä½“èƒŒæ™¯ã¨ã‚³ãƒ³ãƒ†ãƒŠè¨­å®š
     ========================================= */
  .shop-main {
    max-width: 1000px;
    margin: 0 auto;
    background-color: #fff;
    padding-bottom: 50px;
    border: 1px solid #e6e6e6;
    color: #333;
    font-family: "Hiragino Kaku Gothic ProN", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif;
  }

  /* æˆ»ã‚‹ãƒŠãƒ“ */
  .back-nav { padding: 10px 20px; background: #f4f4f2; border-bottom: 1px solid #e6e6e6; }
  .back-link { font-size: 12px; color: #06c; text-decoration: none; }

  /* =========================================
     2. åº—èˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒœã‚¿ãƒ³è¿½åŠ å¯¾å¿œï¼‰
     ========================================= */
  .shop-header { padding: 20px 20px 0; }

  /* ğŸŒŸ åº—åã¨ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ãŸã‚ã®è¨­å®š */
  .header-top-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }

  .shop-name { font-size: 26px; font-weight: bold; margin: 0; }

  /* ğŸŒŸ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç§»æ¤ï¼‰ */
  .action-group {
    display: flex;
    gap: 8px;
    white-space: nowrap;
  }

  .btn-action-white {
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 7px 15px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    color: #333;
    text-decoration: none;
  }
  .btn-action-white span { color: #e91e63; font-size: 16px; }

  .btn-action-green {
    background-color: #8fb134;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 7px 20px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
  }

  /* ã‚¹ã‚³ã‚¢éƒ¨åˆ† */
  .score-container { display: flex; align-items: center; gap: 12px; margin: 10px 0; }
  .stars { color: #ffa500; font-size: 18px; }
  .score-number { color: #e44d26; font-size: 26px; font-weight: bold; }

   .meta-info-text {
    font-size: 13px;
    color: #666;
    margin-bottom: 10px;
    line-height: 1.5;
  }

  /* =========================================
     3. ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ ï¼† ã‚µãƒ–ï¼‰
     ========================================= */
  .main-navigation {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 20px 0 0;
    border-bottom: 1px solid #e2e2e2;
  }
  .main-navigation li {
    flex: 1;
    text-align: center;
    border: 1px solid #e2e2e2;
    margin-right: -1px;
    background: #fdfaf5;
  }
  .main-navigation li.active {
    background-color: #7a6e54;
    border-color: #7a6e54;
  }
  .main-navigation li.active a, .main-navigation li.active span { color: #fff; }
  .main-navigation a, .main-navigation span {
    display: block;
    padding: 14px 0;
    text-decoration: none;
    color: #333;
    font-weight: bold;
    font-size: 14px;
  }

  .sub-navigation {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    background-color: #f9f9f9;
    border-bottom: 2px solid #7a6e54;
    width: 100%;
  }
  .sub-navigation li {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 12px;
    color: #666;
    border-right: 1px solid #eee;
  }
  .sub-navigation li.active {
    background-color: #fff;
    color: #333;
    font-weight: bold;
    border-bottom: 2px solid #ff9900;
    margin-bottom: -2px;
  }

  /* =========================================
     4. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ—¢å­˜ç¶­æŒï¼‰
     ========================================= */
  .flex-body { display: flex; padding: 20px; gap: 40px; }
  .left-content { width: 650px; }
  .right-sidebar { width: 300px; }

  .photo-preview { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
  .photo-preview img { width: 120px; height: 120px; object-fit: cover; border: 1px solid #eee; border-radius: 4px; }

  .info-title { border-left: 4px solid #f90; padding-left: 10px; font-size: 18px; margin: 30px 0 15px; font-weight: bold; }
  .detail-table { width: 100%; border-collapse: collapse; font-size: 13px; border: 1px solid #e2e2e2; }
  .detail-table th { width: 150px; background: #fafafa; border: 1px solid #e2e2e2; padding: 12px; text-align: left; }
  .detail-table td { border: 1px solid #e2e2e2; padding: 12px; }

  .side-box { border: 1px solid #e2e2e2; padding: 16px; margin-bottom: 16px; background: #fff; }
  .btn-primary {
    display: block; width: 100%; background: #ff6600; color: #fff;
    padding: 14px; font-size: 16px; font-weight: bold;
    border-radius: 4px; border: none; cursor: pointer; text-align: center;
  }
  .cal-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px; }
  .cal-cell { text-align: center; padding: 8px 0; border: 1px solid #eee; border-radius: 4px; cursor: pointer; }
  .cal-cell.is-open { border-color: #ff8c00; font-weight: bold; color: #ff8c00; }
  .cal-cell.is-disabled { color: #bbb; cursor: not-allowed; background: #fafafa; }
  .reserve-panel { margin-top: 12px; border-top: 1px solid #eee; padding-top: 12px; display: none; }

  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    z-index: 1000; align-items: center; justify-content: center;
  }
  .modal-box { background: #fff; width: 450px; padding: 30px; border-radius: 8px; position: relative; }
</style>
{% endblock %}

{% block content %}
<div class="shop-main">

 

  <header class="shop-header">
    <!-- ğŸŒŸ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šåº—åã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã« -->
    <div class="header-top-row">
      <h1 class="shop-name">{{ store.store_name }} {{ store.branch_name }}</h1>
      
      <div class="action-group">
        <button class="btn-action-white" type="button"><span>ğŸ“</span>è¡Œã£ãŸ</button>
        
        <!-- âœ… ä¿å­˜æ©Ÿèƒ½ï¼ˆå£ã‚³ãƒŸç”»é¢ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã¸é£›ã°ã™ï¼‰ -->
        <form method="post" action="{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}" style="margin:0;">
          {% csrf_token %}
          <input type="hidden" name="action" value="save_store">
          <input type="hidden" name="store_id" value="{{ store.id }}">
          <button class="btn-action-white" type="submit">
            <span class="icon-pink">ğŸ”–</span>{% if is_saved %}ä¿å­˜æ¸ˆã¿{% else %}ä¿å­˜{% endif %}
          </button>
        </form>

        <button class="btn-action-green" onclick="location.href='{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}#openPostModal'">æŠ•ç¨¿ â–¼</button>
      </div>
    </div>
    
    <div class="score-container">
      <span class="stars">â˜…â˜…â˜…â˜†â˜†</span>
      <span class="score-number">3.00</span>
      <a href="{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}"
         style="color:#06c; font-size:12px; text-decoration:none;">å£ã‚³ãƒŸã‚’è¡¨ç¤º</a>
    </div>

    <div class="meta-info-text">
        ã‚¸ãƒ£ãƒ³ãƒ«ï¼š{{ store.scene.scene_name}}<br>
        äºˆç®—ï¼š ï¿¥{{ store.budget }} ã€œ
    </div>

    <nav>
      <ul class="main-navigation">
        <li class="active"><span>ãƒˆãƒƒãƒ—</span></li>
        <li><a href="{% url 'stores:customer_menu_course' store.pk %}">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚³ãƒ¼ã‚¹</a></li>
        <li><span>å†™çœŸ</span></li>
        <li><a href="{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}">å£ã‚³ãƒŸ</a></li>
        <li><a href="{% url 'stores:customer_map' %}">åœ°å›³</a></li>
      </ul>
      <ul class="sub-navigation">
        <li class="active">ãƒˆãƒƒãƒ—</li>
        <li>ã‚³ãƒ³ã‚»ãƒ—ãƒˆ</li>
        <li>åº§å¸­</li>
        <li>ã“ã ã‚ã‚Š</li>
      </ul>
    </nav>
  </header>

  <div class="flex-body">

    <main class="left-content">
      <section class="photo-preview">
        {% for img in store_images|slice:":5" %}
          {% if img.image_file %}
            <img src="{{ img.image_file.url }}" alt="{{ store.store_name }} ç”»åƒ">
          {% endif %}
        {% endfor %}
      </section>

      <section>
        <h2 class="info-title">åº—èˆ—æƒ…å ±ï¼ˆè©³ç´°ï¼‰</h2>
        <table class="detail-table">
          <tbody>
            <tr>
              <th scope="row">åº—å</th>
              <td>{{ store.store_name }} {{ store.branch_name }}</td>
            </tr>
            <tr>
              <th scope="row">åœ°å›³</th>
              <td>
                {% if store.address %}
                <iframe width="100%" height="250" frameborder="0" style="border:0;"
                    src="https://maps.google.com/maps?q={{ store.address }}&output=embed&z=15"
                    allowfullscreen>
                </iframe>
                <br>
                <a href="https://www.google.com/maps?q={{ store.address }}" target="_blank"
                    style="font-size: 12px; color: #06c;">
                    Googleãƒãƒƒãƒ—ã§å¤§ããè¦‹ã‚‹
                </a>
                {% else %}
                <span style="color: #999;">ä½æ‰€æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th scope="row">ã‚¸ãƒ£ãƒ³ãƒ«</th>
              <td>{{ store.scene.scene_name }}</td>
            </tr>
            <tr>
              <th scope="row">ä½æ‰€</th>
              <td>{{ store.address }}</td>
            </tr>
            <tr>
              <th scope="row">å–¶æ¥­æ™‚é–“</th>
              <td>{{ store.business_hours|linebreaksbr }}</td>
            </tr>
            <tr>
              <th scope="row">æ”¯æ‰•ã„æ–¹æ³•</th>
              <td>åº—èˆ—ã«ã”ç¢ºèªãã ã•ã„ã€‚</td>
            </tr>
          </tbody>
        </table>

        <div class="footer-links">
          <a href="{% url 'stores:store_basic_edit' %}">åº—èˆ—åŸºæœ¬æƒ…å ±ç·¨é›†</a>
          <a href="{% url 'reviews:customer_report_input' %}">åº—èˆ—ã®èª¤ã‚Šãªã©ã‚’å ±å‘Šã™ã‚‹</a>
        </div>
      </section>
    </main>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ç­‰ã€æ—¢å­˜ã‚’ç¶­æŒï¼‰ -->
    <aside class="right-sidebar">
      <div class="side-box">
        <p style="text-align:center; color:#666; font-size:11px; margin:0;">ãŠå•ã„åˆã‚ã›ç•ªå·</p>
        <p style="text-align:center; font-size:22px; font-weight:bold; margin:5px 0;">
          {{ store.phone_number }}
        </p>

        <div style="margin-top:12px;">
          <div class="cal-head">
            <div class="cal-nav">
              <button type="button" class="cal-btn" onclick="moveMonth(-1)">â—€</button>
              <button type="button" class="cal-btn" onclick="moveMonth(1)">â–¶</button>
            </div>
            <div class="cal-ym" id="calYmText">{{ cal_year }}å¹´ {{ cal_month }}æœˆ</div>
          </div>

          <div class="cal-grid" id="calGrid">
            <div class="cal-dow">æ—¥</div><div class="cal-dow">æœˆ</div><div class="cal-dow">ç«</div>
            <div class="cal-dow">æ°´</div><div class="cal-dow">æœ¨</div><div class="cal-dow">é‡‘</div><div class="cal-dow">åœŸ</div>
          </div>

          <div class="reserve-panel" id="reservePanel">
            <div style="font-weight:bold; margin-bottom:8px;">é¸æŠæ—¥ï¼š<span id="pickedDateText">-</span></div>
            <div class="rp-row"><input id="pickedTime" type="time" value="19:00"></div>
            <div class="rp-row">
              <select id="pickedCount">
                {% for i in "12345678910"|make_list %}
                  <option value="{{ forloop.counter }}" {% if forloop.counter == 2 %}selected{% endif %}>{{ forloop.counter }}å</option>
                {% endfor %}
              </select>
              <select id="pickedCourse">
                <option value="120" selected>2æ™‚é–“ã‚³ãƒ¼ã‚¹</option>
              </select>
            </div>
            <button type="button" class="btn-primary" onclick="openReserveModal()">ç©ºå¸­ç¢ºèªãƒ»äºˆç´„ã™ã‚‹</button>
          </div>
        </div>
      </div>
    </aside>

  </div>
</div>

<script>
  // ---- åˆæœŸå€¤ï¼ˆDjangoã‹ã‚‰ï¼‰ ----
  const STORE_ID = {{ store.id }};
  let calYear = {{ cal_year }};
  let calMonth = {{ cal_month }};
  let openDays = new Set({{ open_days|safe }}); // ["YYYY-MM-DD", ...]

  // â˜… ä»Šæ—¥ãƒ»ç¾åœ¨æ™‚åˆ»ï¼ˆã‚µãƒ¼ãƒã®ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ï¼‰
  const TODAY_STR = "{{ today|date:'Y-m-d' }}";     // ä¾‹: "2026-01-23"
  const NOW_HM = "{{ now_hm }}";                   // ä¾‹: "11:35"ï¼ˆviewã§æ¸¡ã™ï¼‰

  const todayDate = new Date(TODAY_STR + "T00:00:00");
  const nowDateTime = new Date(TODAY_STR + "T" + NOW_HM + ":00");

  let pickedDate = null;

  function ymString(y, m){
    const mm = String(m).padStart(2, "0");
    return `${y}-${mm}`;
  }
  function isoDate(y, m, d){
    const mm = String(m).padStart(2, "0");
    const dd = String(d).padStart(2, "0");
    return `${y}-${mm}-${dd}`;
  }
  function parseIsoDate(iso){
    return new Date(iso + "T00:00:00");
  }

  // ---- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ----
  function renderCalendar(){
    document.getElementById("calYmText").textContent = `${calYear}å¹´ ${calMonth}æœˆ`;

    const grid = document.getElementById("calGrid");

    // æ›œæ—¥ãƒ˜ãƒƒãƒ€ï¼ˆ7å€‹ï¼‰ã¯æ®‹ã—ã¦ã€ä»¥é™ã‚’å…¨å‰Šé™¤
    while (grid.children.length > 7) grid.removeChild(grid.lastChild);

    const first = new Date(calYear, calMonth - 1, 1);
    const startDow = first.getDay(); // 0=Sun
    const lastDay = new Date(calYear, calMonth, 0).getDate();

    // ç©ºã‚»ãƒ«
    for(let i=0;i<startDow;i++){
      const cell = document.createElement("div");
      cell.className = "cal-cell is-empty";
      grid.appendChild(cell);
    }

    for(let d=1; d<=lastDay; d++){
      const cell = document.createElement("div");
      const iso = isoDate(calYear, calMonth, d);
      const cellDate = parseIsoDate(iso);

      cell.className = "cal-cell";
      cell.textContent = d;

      // â˜… æ˜¨æ—¥ä»¥å‰ï¼ˆä»Šæ—¥ã‚ˆã‚Šå‰ï¼‰ã¯è§¦ã‚Œãªã„
      if (cellDate < todayDate){
        cell.classList.add("is-disabled");
        cell.style.pointerEvents = "none";
        grid.appendChild(cell);
        continue;
      }

      // ä»Šæ—¥ä»¥é™ã¯ openDays ã ã‘â—‹
      if(openDays.has(iso)){
        cell.classList.add("is-open");
        cell.addEventListener("click", () => pickDate(iso));
      }else{
        cell.classList.add("is-disabled");
        cell.style.pointerEvents = "none";
      }

      grid.appendChild(cell);
    }
  }

  function pickDate(iso){
    // â˜… å¿µã®ãŸã‚ï¼šéå»æ—¥ã‚¯ãƒªãƒƒã‚¯ä¸å¯
    if (parseIsoDate(iso) < todayDate) return;

    pickedDate = iso;
    document.getElementById("reservePanel").style.display = "block";
    document.getElementById("pickedDateText").textContent = iso;

    // â˜… ä»Šæ—¥ãªã‚‰ time ã‚’ã€Œã„ã¾ä»¥é™ã€ã«åˆ¶é™
    const timeEl = document.getElementById("pickedTime");
    if (pickedDate === TODAY_STR){
      timeEl.min = NOW_HM;

      // é¸æŠä¸­ãŒéå»ãªã‚‰ã€ç¾åœ¨æ™‚åˆ»ã«å¯„ã›ã‚‹ï¼ˆåˆ†ã®ç«¯æ•°ã§ min ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ï¼‰
      if (timeEl.value && timeEl.value < NOW_HM){
        timeEl.value = NOW_HM;
      }
    } else {
      timeEl.min = ""; // ä»Šæ—¥ä»¥å¤–ã¯è§£é™¤
    }
  }

  // ---- æœˆç§»å‹•ï¼šã‚µãƒ¼ãƒã‹ã‚‰open_daysã‚’å–å¾— ----
  async function moveMonth(delta){
    calMonth += delta;
    if(calMonth <= 0){ calMonth = 12; calYear -= 1; }
    if(calMonth >= 13){ calMonth = 1; calYear += 1; }

    pickedDate = null;
    document.getElementById("reservePanel").style.display = "none";

    const ym = ymString(calYear, calMonth);
    const url = "{% url 'stores:availability_json' 0 %}".replace("/0/", `/${STORE_ID}/`) + `?ym=${ym}`;

    const res = await fetch(url);
    const data = await res.json();

    openDays = new Set(data.open_days);
    calYear = data.year;
    calMonth = data.month;

    renderCalendar();
  }

  // ---- ãƒ¢ãƒ¼ãƒ€ãƒ« ----
  function openReserveModal(){
    if(!pickedDate) return;

    const t = document.getElementById("pickedTime").value || "19:00";

    // â˜… ä»Šæ—¥ï¼†ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå‰ãªã‚‰NGï¼ˆæœ€çµ‚é˜²è¡›ï¼‰
    if (pickedDate === TODAY_STR && t < NOW_HM){
      alert("ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå‰ã¯äºˆç´„ã§ãã¾ã›ã‚“ã€‚");
      document.getElementById("pickedTime").value = NOW_HM;
      return;
    }
    // â˜… å¿µã®ãŸã‚ï¼šéå»æ—¥ãªã‚‰NG
    if (parseIsoDate(pickedDate) < todayDate){
      alert("éå»ã®æ—¥ä»˜ã¯äºˆç´„ã§ãã¾ã›ã‚“ã€‚");
      return;
    }

const p = document.getElementById("pickedCount").value || "2";
const c = document.getElementById("pickedCourse").value || "120";

document.getElementById("f_visit_date").value = pickedDate;
document.getElementById("f_visit_time").value = t;
document.getElementById("f_visit_count").value = p;
document.getElementById("f_course_minutes").value = c;

// 30åˆ†åˆ»ã¿ã€œ150åˆ†ï¼ˆ2æ™‚é–“30åˆ†ï¼‰ã¾ã§å¯¾å¿œï¼šè¡¨ç¤ºã¯ã€Œâ—‹â—‹åˆ†ã‚³ãƒ¼ã‚¹ã€ã«çµ±ä¸€
const courseText = `${c}åˆ†ã‚³ãƒ¼ã‚¹`;

document.getElementById("modalSubText").textContent =
  `${pickedDate} ${t} / ${p}å / ${courseText}`;

document.getElementById("reserveModal").style.display = "flex";
}
function closeReserveModal(){
  document.getElementById("reserveModal").style.display = "none";
}


  // åˆæœŸæç”»
  renderCalendar();
</script>
{% endblock %}
