{% extends "customer_base.html" %}

{% block title %}{{ store.store_name }} - åº—èˆ—æƒ…å ±{% endblock %}

{% block css %}
<style>
  .shop-main {
    max-width: 1000px;
    margin: 0 auto;
    background: #fff;
    border: 1px solid #e6e6e6;
    color: #333;
    font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
  }

  .back-nav { padding: 10px 20px; background: #f4f4f2; border-bottom: 1px solid #e6e6e6; }
  .back-link { font-size: 12px; color: #06c; text-decoration: none; }

  .shop-header { padding: 20px 20px 0 20px; }
  .shop-name { display: inline; font-size: 24px; font-weight: bold; }

  .score-container { display:flex; align-items: baseline; margin-top:10px; gap:12px; }
  .score-number { font-size:24px; font-weight:bold; color:#e44d26; }

  .tab-menu { display:flex; list-style:none; padding:0; margin:20px 0 0; border-bottom:2px solid #9c8e71; }
  .tab-menu li { padding:8px 16px; border:1px solid #e6e6e6; border-bottom:none; margin-right:2px; font-size:14px; font-weight:bold; background:#fff; }
  .tab-menu li a { text-decoration:none; color:#333; }
  .tab-menu li.active { background:#9c8e71; color:#fff; border-color:#9c8e71; }

  .flex-body { display:flex; padding:20px; gap:20px; }
  .left-content { width:650px; }
  .right-sidebar { width:300px; }

  /* åº—èˆ—ç”»åƒ */
  .photo-preview { display:flex; gap:5px; margin-bottom:20px; flex-wrap:wrap; }
  .photo-preview img { width:125px; height:125px; object-fit:cover; border:1px solid #eee; border-radius:6px; }

  .info-title { font-size:18px; border-left:4px solid #9c8e71; padding-left:10px; margin:30px 0 15px; }
  .detail-table { width:100%; border-collapse:collapse; font-size:13px; border-top:2px solid #eee; }
  .detail-table th { width:180px; background:#fafaf8; border:1px solid #e6e6e6; padding:12px; text-align:left; }
  .detail-table td { border:1px solid #e6e6e6; padding:12px; }

  .footer-links { margin-top:20px; padding-top:15px; border-top:1px solid #eee; font-size:12px; }
  .footer-links a { color:#06c; margin-right:15px; text-decoration:none; }

  /* å³ï¼šã‚«ãƒ¼ãƒ‰ */
  .side-box { border:1px solid #e6e6e6; padding:15px; margin-bottom:20px; border-radius:10px; }
  .btn-primary {
    display:block; width:100%;
    background:#00a0e9; color:#fff;
    padding:12px; font-size:16px; font-weight:bold;
    border-radius:6px; border:none; cursor:pointer;
  }
  .btn-ghost {
    display:inline-block;
    background:#fff; color:#333;
    padding:10px 12px; font-weight:bold;
    border-radius:6px; border:1px solid #ddd; cursor:pointer;
  }

  /* äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  .cal-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; }
  .cal-ym { font-weight:bold; }
  .cal-nav { display:flex; gap:6px; }
  .cal-btn { border:1px solid #ddd; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; }

  .cal-grid {
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:6px;
    font-size:12px;
  }
  .cal-dow { text-align:center; color:#777; padding:6px 0; }
  .cal-cell {
    text-align:center;
    padding:10px 0;
    border:1px solid #eee;
    border-radius:8px;
    cursor:pointer;
    user-select:none;
  }
  .cal-cell.is-empty { border:none; cursor:default; }
  .cal-cell.is-open { border-color:#ff8c00; position:relative; }
  .cal-cell.is-open::after{
    content:"â—‹";
    position:absolute;
    right:6px; bottom:4px;
    font-size:12px;
    color:#ff8c00;
    font-weight:bold;
  }
  .cal-cell.is-disabled { color:#bbb; cursor:not-allowed; background:#fafafa; }

  .reserve-panel { margin-top:12px; border-top:1px solid #eee; padding-top:12px; display:none; }
  .rp-row { display:flex; gap:8px; margin-bottom:10px; }
  .rp-row select, .rp-row input {
    width:100%;
    padding:10px;
    border:1px solid #ddd;
    border-radius:8px;
  }
  .rp-note { font-size:12px; color:#666; margin-top:6px; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-overlay{
    display:none;
    position:fixed; inset:0;
    background:rgba(0,0,0,0.6);
    z-index:1000;
    align-items:center;
    justify-content:center;
  }
  .modal-box{
    background:#fff;
    width:520px;
    max-width:92vw;
    padding:22px;
    border-radius:12px;
    position:relative;
  }
  .modal-close{
    position:absolute;
    top:10px; right:14px;
    font-size:22px;
    cursor:pointer;
    color:#999;
  }
  .modal-title{ font-size:18px; font-weight:bold; margin:0 0 8px; }
  .modal-sub{ font-size:13px; color:#666; margin:0 0 14px; }
  .m-row{ display:flex; gap:10px; margin-bottom:10px; }
  .m-row input, .m-row textarea, .m-row select{
    width:100%;
    padding:10px;
    border:1px solid #ddd;
    border-radius:8px;
  }
  .m-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
</style>
{% endblock %}

{% block content %}
<div class="shop-main">

  <nav class="back-nav">
    <a href="{% url 'accounts:customer_top' %}" class="back-link">Â« æ¤œç´¢çµæœã¸æˆ»ã‚‹</a>
  </nav>

  <header class="shop-header">
    <h1 class="shop-name">{{ store.store_name }} {{ store.branch_name }}</h1>

    <div class="score-container">
      <span class="stars">â˜…â˜…â˜…â˜†â˜†</span>
      <span class="score-number">3.00</span>
      <a href="{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}"
         style="color:#06c; font-size:12px; text-decoration:none;">å£ã‚³ãƒŸã‚’è¡¨ç¤º</a>
    </div>

    <nav>
      <ul class="tab-menu">
        <li class="active">ãƒˆãƒƒãƒ—</li>
        <li><a href="{% url 'stores:customer_menu_course' store.pk %}">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚³ãƒ¼ã‚¹</a></li>
        <li>å†™çœŸ</li>
        <li><a href="{% url 'reviews:customer_review_list' %}?store_id={{ store.id }}">å£ã‚³ãƒŸ</a></li>
        <li><a href="{% url 'stores:customer_map' %}">åœ°å›³</a></li>
      </ul>
    </nav>
  </header>

  <div class="flex-body">

    <main class="left-content">
      <section class="photo-preview">
        {% for img in store_images|slice:":5" %}
          {% if img.image_file %}
            <img src="{{ img.image_file.url }}" alt="{{ store.store_name }} ç”»åƒ">
          {% endif %}
        {% endfor %}
      </section>

      <section>
        <h2 class="info-title">åº—èˆ—æƒ…å ±ï¼ˆè©³ç´°ï¼‰</h2>
        <table class="detail-table">
          <tbody>
            <tr>
              <th scope="row">åº—å</th>
              <td>{{ store.store_name }} {{ store.branch_name }}</td>
            </tr>
            <tr>
              <th scope="row">åœ°å›³</th>
              <td>
                                <!-- ğŸŒŸ ä½æ‰€ã‚’ä½¿ã£ã¦Googleãƒãƒƒãƒ—ã‚’åŸ‹ã‚è¾¼ã¿è¡¨ç¤º -->
                                {% if store.address %}
                                <iframe width="100%" height="250" frameborder="0" style="border:0;"
                                    src="https://maps.google.com/maps?q={{ store.address }}&output=embed&z=15"
                                    allowfullscreen>
                                </iframe>
                                <br>
                                <a href="https://www.google.com/maps?q={{ store.address }}" target="_blank"
                                    style="font-size: 12px; color: #06c;">
                                    Googleãƒãƒƒãƒ—ã§å¤§ããè¦‹ã‚‹
                                </a>
                                {% else %}
                                <span style="color: #999;">ä½æ‰€æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</span>
                                {% endif %}
                            </td>
            </tr>
            <tr>
              <th scope="row">ã‚¸ãƒ£ãƒ³ãƒ«</th>
              <td>{{ store.scene.scene_name }}</td>
            </tr>
            <tr>
              <th scope="row">ä½æ‰€</th>
              <td>{{ store.address }}</td>
            </tr>
            <tr>
              <th scope="row">å–¶æ¥­æ™‚é–“</th>
              <td>{{ store.business_hours|linebreaksbr }}</td>
            </tr>
            <tr>
              <th scope="row">æ”¯æ‰•ã„æ–¹æ³•</th>
              <td>åº—èˆ—ã«ã”ç¢ºèªãã ã•ã„ã€‚</td>
            </tr>
          </tbody>
        </table>

        <div class="footer-links">
          <a href="{% url 'stores:store_basic_edit' %}">åº—èˆ—åŸºæœ¬æƒ…å ±ç·¨é›†</a>
          <a href="{% url 'reviews:customer_report_input' %}">åº—èˆ—ã®èª¤ã‚Šãªã©ã‚’å ±å‘Šã™ã‚‹</a>
        </div>
      </section>
    </main>

    <aside class="right-sidebar">
      <div class="side-box">
        <p style="text-align:center; color:#666; font-size:11px; margin:0;">ãŠå•ã„åˆã‚ã›ç•ªå·</p>
        <p style="text-align:center; font-size:22px; font-weight:bold; margin:5px 0;">
          {{ store.phone_number }}
        </p>

        <div style="margin-top:12px;">
          <div class="cal-head">
            <div class="cal-nav">
              <button type="button" class="cal-btn" onclick="moveMonth(-1)">â—€</button>
              <button type="button" class="cal-btn" onclick="moveMonth(1)">â–¶</button>
            </div>
            <div class="cal-ym" id="calYmText">{{ cal_year }}å¹´ {{ cal_month }}æœˆ</div>
          </div>

          <div class="cal-grid" id="calGrid">
            <div class="cal-dow">æ—¥</div><div class="cal-dow">æœˆ</div><div class="cal-dow">ç«</div>
            <div class="cal-dow">æ°´</div><div class="cal-dow">æœ¨</div><div class="cal-dow">é‡‘</div><div class="cal-dow">åœŸ</div>
          </div>

          <div class="reserve-panel" id="reservePanel">
            <div style="font-weight:bold; margin-bottom:8px;">
              é¸æŠæ—¥ï¼š<span id="pickedDateText">-</span>
            </div>

            <div class="rp-row">
              <!-- â˜… ä»Šæ—¥ã®å ´åˆã ã‘ min ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ï¼ˆJSã§åˆ¶å¾¡ï¼‰ -->
              <input id="pickedTime" type="time" value="19:00">
            </div>

            <div class="rp-row">
              <select id="pickedCount">
                <option value="1">1å</option>
                <option value="2" selected>2å</option>
                <option value="3">3å</option>
                <option value="4">4å</option>
                <option value="5">5å</option>
                <option value="6">6å</option>
                <option value="7">7å</option>
                <option value="8">8å</option>
                <option value="9">9å</option>
                <option value="10">10å</option>
              </select>
              <select id="pickedCourse">

                <option value="30">30åˆ†ã‚³ãƒ¼ã‚¹</option>
                <option value="60">1æ™‚é–“ã‚³ãƒ¼ã‚¹</option>
                <option value="90">1æ™‚é–“30åˆ†ã‚³ãƒ¼ã‚¹</option>
                <option value="120" selected>2æ™‚é–“ã‚³ãƒ¼ã‚¹</option>
                <option value="150">2æ™‚é–“30åˆ†ã‚³ãƒ¼ã‚¹</option>

              </select>
            </div>

            <button type="button" class="btn-primary" onclick="openReserveModal()">
              ç©ºå¸­ç¢ºèªãƒ»äºˆç´„ã™ã‚‹
            </button>
            <div class="rp-note">â—‹ã®æ—¥ä»˜ã®ã¿äºˆç´„ã§ãã¾ã™ï¼ˆç°¡æ˜“ç‰ˆï¼šæ—¥å˜ä½ï¼‰ã€‚</div>
          </div>

        </div>
      </div>

      <div class="side-box">
        <p style="font-size:14px; font-weight:bold; margin:0;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚³ãƒ¼ã‚¹</p>
        <p style="font-size:12px; margin-top:10px;">
          <a href="{% url 'stores:customer_menu_course' store.pk %}" style="color:#06c; text-decoration:none;">
            ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚³ãƒ¼ã‚¹ã‚’è¦‹ã‚‹
          </a>
        </p>
      </div>
    </aside>

  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="reserveModal" onclick="closeReserveModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="modal-close" onclick="closeReserveModal()">&times;</span>

    <div class="modal-title">äºˆç´„æƒ…å ±ã®å…¥åŠ›</div>
    <div class="modal-sub" id="modalSubText">-</div>

    <form method="post" action="{% url 'stores:customer_reserve_create' store.id %}">
      {% csrf_token %}

      <input type="hidden" name="visit_date" id="f_visit_date">
      <input type="hidden" name="visit_time" id="f_visit_time">
      <input type="hidden" name="visit_count" id="f_visit_count">
      <input type="hidden" name="course_minutes" id="f_course_minutes">

      <div class="m-row">
        <input name="full_name" placeholder="æ°å"
          value="{% if login_customer %}{{ login_customer.nickname }}{% endif %}">
        <input name="full_name_kana" placeholder="æ°åã‹ãª" value="">
      </div>

      <div class="m-row">
        <input name="phone_number" placeholder="é›»è©±ç•ªå·"
          value="{% if login_customer %}{{ login_customer.phone_number }}{% endif %}">
        <input name="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
          value="{% if login_customer %}{{ login_customer.sub_email }}{% endif %}">
      </div>

      <div class="m-row">
        <textarea name="note" placeholder="ãŠåº—ã¸ã®ã”è¦æœ›ï¼ˆä»»æ„ï¼‰"></textarea>
      </div>

      <div class="m-actions">
        <button type="button" class="btn-ghost" onclick="closeReserveModal()">æˆ»ã‚‹</button>
        <button type="submit" class="btn-primary" style="width:auto; padding:10px 16px;">äºˆç´„ã™ã‚‹</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ---- åˆæœŸå€¤ï¼ˆDjangoã‹ã‚‰ï¼‰ ----
  const STORE_ID = {{ store.id }};
  let calYear = {{ cal_year }};
  let calMonth = {{ cal_month }};
  let openDays = new Set({{ open_days|safe }}); // ["YYYY-MM-DD", ...]

  // â˜… ä»Šæ—¥ãƒ»ç¾åœ¨æ™‚åˆ»ï¼ˆã‚µãƒ¼ãƒã®ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ï¼‰
  const TODAY_STR = "{{ today|date:'Y-m-d' }}";     // ä¾‹: "2026-01-23"
  const NOW_HM = "{{ now_hm }}";                   // ä¾‹: "11:35"ï¼ˆviewã§æ¸¡ã™ï¼‰

  const todayDate = new Date(TODAY_STR + "T00:00:00");
  const nowDateTime = new Date(TODAY_STR + "T" + NOW_HM + ":00");

  let pickedDate = null;

  function ymString(y, m){
    const mm = String(m).padStart(2, "0");
    return `${y}-${mm}`;
  }
  function isoDate(y, m, d){
    const mm = String(m).padStart(2, "0");
    const dd = String(d).padStart(2, "0");
    return `${y}-${mm}-${dd}`;
  }
  function parseIsoDate(iso){
    return new Date(iso + "T00:00:00");
  }

  // ---- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ----
  function renderCalendar(){
    document.getElementById("calYmText").textContent = `${calYear}å¹´ ${calMonth}æœˆ`;

    const grid = document.getElementById("calGrid");

    // æ›œæ—¥ãƒ˜ãƒƒãƒ€ï¼ˆ7å€‹ï¼‰ã¯æ®‹ã—ã¦ã€ä»¥é™ã‚’å…¨å‰Šé™¤
    while (grid.children.length > 7) grid.removeChild(grid.lastChild);

    const first = new Date(calYear, calMonth - 1, 1);
    const startDow = first.getDay(); // 0=Sun
    const lastDay = new Date(calYear, calMonth, 0).getDate();

    // ç©ºã‚»ãƒ«
    for(let i=0;i<startDow;i++){
      const cell = document.createElement("div");
      cell.className = "cal-cell is-empty";
      grid.appendChild(cell);
    }

    for(let d=1; d<=lastDay; d++){
      const cell = document.createElement("div");
      const iso = isoDate(calYear, calMonth, d);
      const cellDate = parseIsoDate(iso);

      cell.className = "cal-cell";
      cell.textContent = d;

      // â˜… æ˜¨æ—¥ä»¥å‰ï¼ˆä»Šæ—¥ã‚ˆã‚Šå‰ï¼‰ã¯è§¦ã‚Œãªã„
      if (cellDate < todayDate){
        cell.classList.add("is-disabled");
        cell.style.pointerEvents = "none";
        grid.appendChild(cell);
        continue;
      }

      // ä»Šæ—¥ä»¥é™ã¯ openDays ã ã‘â—‹
      if(openDays.has(iso)){
        cell.classList.add("is-open");
        cell.addEventListener("click", () => pickDate(iso));
      }else{
        cell.classList.add("is-disabled");
        cell.style.pointerEvents = "none";
      }

      grid.appendChild(cell);
    }
  }

  function pickDate(iso){
    // â˜… å¿µã®ãŸã‚ï¼šéå»æ—¥ã‚¯ãƒªãƒƒã‚¯ä¸å¯
    if (parseIsoDate(iso) < todayDate) return;

    pickedDate = iso;
    document.getElementById("reservePanel").style.display = "block";
    document.getElementById("pickedDateText").textContent = iso;

    // â˜… ä»Šæ—¥ãªã‚‰ time ã‚’ã€Œã„ã¾ä»¥é™ã€ã«åˆ¶é™
    const timeEl = document.getElementById("pickedTime");
    if (pickedDate === TODAY_STR){
      timeEl.min = NOW_HM;

      // é¸æŠä¸­ãŒéå»ãªã‚‰ã€ç¾åœ¨æ™‚åˆ»ã«å¯„ã›ã‚‹ï¼ˆåˆ†ã®ç«¯æ•°ã§ min ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ï¼‰
      if (timeEl.value && timeEl.value < NOW_HM){
        timeEl.value = NOW_HM;
      }
    } else {
      timeEl.min = ""; // ä»Šæ—¥ä»¥å¤–ã¯è§£é™¤
    }
  }

  // ---- æœˆç§»å‹•ï¼šã‚µãƒ¼ãƒã‹ã‚‰open_daysã‚’å–å¾— ----
  async function moveMonth(delta){
    calMonth += delta;
    if(calMonth <= 0){ calMonth = 12; calYear -= 1; }
    if(calMonth >= 13){ calMonth = 1; calYear += 1; }

    pickedDate = null;
    document.getElementById("reservePanel").style.display = "none";

    const ym = ymString(calYear, calMonth);
    const url = "{% url 'stores:availability_json' 0 %}".replace("/0/", `/${STORE_ID}/`) + `?ym=${ym}`;

    const res = await fetch(url);
    const data = await res.json();

    openDays = new Set(data.open_days);
    calYear = data.year;
    calMonth = data.month;

    renderCalendar();
  }

  // ---- ãƒ¢ãƒ¼ãƒ€ãƒ« ----
  function openReserveModal(){
    if(!pickedDate) return;

    const t = document.getElementById("pickedTime").value || "19:00";

    // â˜… ä»Šæ—¥ï¼†ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå‰ãªã‚‰NGï¼ˆæœ€çµ‚é˜²è¡›ï¼‰
    if (pickedDate === TODAY_STR && t < NOW_HM){
      alert("ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå‰ã¯äºˆç´„ã§ãã¾ã›ã‚“ã€‚");
      document.getElementById("pickedTime").value = NOW_HM;
      return;
    }
    // â˜… å¿µã®ãŸã‚ï¼šéå»æ—¥ãªã‚‰NG
    if (parseIsoDate(pickedDate) < todayDate){
      alert("éå»ã®æ—¥ä»˜ã¯äºˆç´„ã§ãã¾ã›ã‚“ã€‚");
      return;
    }

const p = document.getElementById("pickedCount").value || "2";
const c = document.getElementById("pickedCourse").value || "120";

document.getElementById("f_visit_date").value = pickedDate;
document.getElementById("f_visit_time").value = t;
document.getElementById("f_visit_count").value = p;
document.getElementById("f_course_minutes").value = c;

// 30åˆ†åˆ»ã¿ã€œ150åˆ†ï¼ˆ2æ™‚é–“30åˆ†ï¼‰ã¾ã§å¯¾å¿œï¼šè¡¨ç¤ºã¯ã€Œâ—‹â—‹åˆ†ã‚³ãƒ¼ã‚¹ã€ã«çµ±ä¸€
const courseText = `${c}åˆ†ã‚³ãƒ¼ã‚¹`;

document.getElementById("modalSubText").textContent =
  `${pickedDate} ${t} / ${p}å / ${courseText}`;

document.getElementById("reserveModal").style.display = "flex";
}
function closeReserveModal(){
  document.getElementById("reserveModal").style.display = "none";
}


  // åˆæœŸæç”»
  renderCalendar();
</script>
{% endblock %}
