{% extends "customer_base.html" %}

{% block title %}{{ store.store_name }} - åº—èˆ—æƒ…å ±{% endblock %}

{% block css %}
<style>
.shop-main{max-width:1000px;margin:0 auto;background:#fff;border:1px solid #e6e6e6;color:#333;font-family:"Hiragino Kaku Gothic ProN","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;}
.flex-body{display:flex;gap:40px;padding:20px;}
.left-content{width:650px;}
.right-sidebar{width:300px;}
@media (max-width:720px){.flex-body{flex-direction:column;}.left-content,.right-sidebar{width:100%;}}

.photo-preview{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px;}
.photo-preview img{width:120px;height:120px;object-fit:cover;border-radius:6px;border:1px solid #eee;}

.info-title{border-left:4px solid #ff9900;padding-left:10px;font-size:18px;font-weight:bold;margin:30px 0 15px;}
.detail-table{width:100%;border-collapse:collapse;border:1px solid #e2e2e2;font-size:13px;}
.detail-table th{width:150px;background:#fafafa;border:1px solid #e2e2e2;padding:12px;text-align:left;}
.detail-table td{border:1px solid #e2e2e2;padding:12px;}

.side-box{border:1px solid #e2e2e2;background:#fff;padding:16px;margin-bottom:16px;border-radius:10px;}
.phone-number{text-align:center;font-size:22px;font-weight:bold;margin:6px 0 16px;}

.no-reserve-box{margin:10px 0 12px;padding:12px;border:1px solid #eee;background:#fafafa;border-radius:10px;}
.no-reserve-text{margin:0 0 8px;color:#666;font-size:12px;line-height:1.4;}
.next-month-btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#7a6e54;color:#fff;text-decoration:none;font-weight:bold;font-size:12px;}
.next-month-btn:hover{opacity:.9;}

.reserve-panel{display:none;border-top:1px solid #eee;margin-top:12px;padding-top:12px;}
.btn-primary{width:100%;background:#ff6600;color:#fff;border:none;border-radius:8px;font-weight:bold;padding:14px;margin-top:10px;cursor:pointer;}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}

.form-row{margin:10px 0;}
.label{font-size:12px;color:#555;margin-bottom:6px;}
.select, .input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px;background:#fff;}
.hint{font-size:11px;color:#888;margin-top:6px;line-height:1.4;}
.badge{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;background:#f5f5f5;border:1px solid #eee;color:#666;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media (max-width:720px){.row2{grid-template-columns:1fr;}}

/* ===== æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆã‚¹ã‚¯ã‚·ãƒ§å¯„ã›ï¼‰ ===== */
.cal-wrap{margin-top:10px;}
.cal-head{display:flex;align-items:center;justify-content:space-between;margin:8px 0 10px;}
.cal-month{font-weight:bold;font-size:14px;}
.cal-nav{display:flex;gap:8px;}
.cal-nav a, .cal-nav span{
  display:inline-flex;align-items:center;justify-content:center;
  width:34px;height:34px;border-radius:10px;border:1px solid #eee;
  background:#fff;color:#333;text-decoration:none;font-weight:bold;
}
.cal-nav span{opacity:.35;cursor:not-allowed;}
.cal-week{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;}
.cal-week div{font-size:11px;color:#777;text-align:center;}

.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.cal-cell{
  border:1px solid #eee;border-radius:12px;
  height:44px;display:flex;align-items:center;justify-content:center;
  font-size:13px;user-select:none;
  position:relative; /* ãƒ‰ãƒƒãƒˆç”¨ */
}
.cal-cell.is-out{background:#fafafa;color:#bbb;}
.cal-cell.is-disabled{background:#fafafa;color:#bbb;}
.cal-cell.is-open{
  background:#fffaf2;color:#ff8c00;border-color:#ffcf9c;
  font-weight:bold;cursor:pointer;
}
.cal-cell.is-selected{outline:2px solid #ff6600;}

/* ===== åœŸæ—¥ã‚«ãƒ©ãƒ¼ ===== */
.cal-cell.is-sat{ color:#2a6cdf; } /* é’ */
.cal-cell.is-sun{ color:#d83a2e; } /* èµ¤ */

/* open ã®ã¨ãã¯ã‚ªãƒ¬ãƒ³ã‚¸ãŒå‹ã¤ï¼ˆæ•°å­—ã¯ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ */
.cal-cell.is-open.is-sat,
.cal-cell.is-open.is-sun{
  color:#ff8c00;
}

/* ç„¡åŠ¹æ—¥ã¯è–„ã */
.cal-cell.is-disabled.is-sat,
.cal-cell.is-disabled.is-sun{
  color:#bbb;
}

/* ===== å—ä»˜æ—¥ã‚ªãƒ¬ãƒ³ã‚¸â—‹ ===== */
.open-dot{
  position:absolute;
  bottom:6px;
  left:50%;
  transform:translateX(-50%);
  width:6px;height:6px;border-radius:50%;
  background:#ff8c00;
}
.cal-cell.is-selected .open-dot{ background:#ff6600; }

/* ===== modal ===== */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;}
.modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(560px,92vw);background:#fff;border-radius:14px;z-index:9999;border:1px solid #eee;box-shadow:0 10px 30px rgba(0,0,0,.25);}
.modal-head{padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
.modal-title{font-weight:bold;}
.modal-close{border:none;background:transparent;font-size:18px;cursor:pointer;}
.modal-body{padding:14px 16px;}
.modal-foot{padding:14px 16px;border-top:1px solid #eee;}
.btn-sub{width:100%;background:#222;color:#fff;border:none;border-radius:10px;font-weight:bold;padding:14px;cursor:pointer;}
.btn-sub:disabled{opacity:.5;cursor:not-allowed;}
</style>
{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumbs">
  <ol>
    <li><a href="{% url 'accounts:customer_top' %}">ãƒˆãƒƒãƒ—</a></li>
    <li><a href="{% url 'search:customer_search_list' %}?keyword={{ store.scene.scene_name }}">{{ store.scene.scene_name }}</a></li>
    <li><span>{{ store.store_name }}</span></li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="shop-main">

  {% include "stores/_customer_store_common.html" with store=store is_saved=is_saved star_states=star_states avg_rating=avg_rating review_count=review_count active_main="top" active_sub="top" %}

  <div class="flex-body">

    <main class="left-content">
      <section class="photo-preview">
        {% for img in store_images|slice:":5" %}
        {% if img.image_file %}
        <img src="{{ img.image_file.url }}" alt="{{ store.store_name }}">
        {% endif %}
        {% endfor %}
      </section>

      <section>
        <h2 class="info-title">åº—èˆ—æƒ…å ±ï¼ˆè©³ç´°ï¼‰</h2>
        <table class="detail-table">
          <tbody>
            <tr><th>åº—å</th><td>{{ store.store_name }}{% if store.branch_name %} {{ store.branch_name }}{% endif %}</td></tr>
            <tr><th>ä½æ‰€</th><td>{{ store.address }} <a href="{% url 'stores:customer_store_map' store.pk %}" style="display:inline-block; margin-left:10px; padding:2px 8px; background:#ff9900; color:#fff; text-decoration:none; border-radius:4px; font-size:11px; font-weight:bold;">ğŸ“ åœ°å›³ã‚’è¦‹ã‚‹</a></td></tr>
            <tr><th>ã‚¸ãƒ£ãƒ³ãƒ«</th><td>{{ store.scene.scene_name }}</td></tr>
            <tr><th>å–¶æ¥­æ™‚é–“</th><td>{{ store.business_hours|linebreaksbr }}</td></tr>
          </tbody>
        </table>
      </section>
    </main>

    <aside class="right-sidebar">
      <div class="side-box">
        <div style="text-align:center;font-size:11px;color:#666;">ãŠå•ã„åˆã‚ã›ç•ªå·</div>
        <div class="phone-number">{{ store.phone_number }}</div>

        {% if has_account %}

          <div class="cal-wrap">
            <div class="cal-head">
              <div>
                <div style="font-weight:bold;">ãƒãƒƒãƒˆäºˆç´„</div>
                <div class="badge">{{ cal_year }}å¹´{{ cal_month }}æœˆ</div>
              </div>

              <div class="cal-nav">
                {% if cal_prev_allowed %}
                  <a href="{% url 'stores:customer_store_info' store.pk %}?ym={{ cal_prev_ym }}">â€¹</a>
                {% else %}
                  <span>â€¹</span>
                {% endif %}
                <a href="{% url 'stores:customer_store_info' store.pk %}?ym={{ cal_next_ym }}">â€º</a>
              </div>
            </div>

            {% if open_days|length == 0 %}
              <div class="no-reserve-box">
                <p class="no-reserve-text">ä»Šæœˆã¯äºˆç´„å—ä»˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <a class="next-month-btn" href="{% url 'stores:customer_store_info' store.pk %}?ym={{ cal_next_ym }}">
                  æ¥æœˆã‚’è¦‹ã‚‹ â†’
                </a>
              </div>
            {% endif %}

            <div class="cal-week">
              {% for w in weekdays_ja %}
                <div>{{ w }}</div>
              {% endfor %}
            </div>

            <div class="cal-grid" id="calGrid">
              {% for c in calendar_cells %}
                <div
                  class="cal-cell
                    {% if not c.in_month %}is-out{% endif %}
                    {% if c.weekday == 5 %}is-sat{% endif %}
                    {% if c.weekday == 6 %}is-sun{% endif %}
                    {% if c.is_disabled %}is-disabled{% endif %}
                    {% if c.is_open %}is-open{% endif %}
                  "
                  data-iso="{{ c.iso }}"
                  data-in-month="{% if c.in_month %}1{% else %}0{% endif %}"
                >
                  <span class="day-num">{{ c.day }}</span>
                  {% if c.is_open %}
                    <span class="open-dot"></span>
                  {% endif %}
                </div>
              {% endfor %}
            </div>

            <!-- äºˆç´„ãƒ‘ãƒãƒ«ï¼ˆé¸æŠå¾Œã«è¡¨ç¤ºï¼‰ -->
            <div class="reserve-panel" id="reservePanel">
              <div class="form-row">
                <div class="label">é¸æŠæ—¥</div>
                <div class="input" id="selectedDateLabel" style="background:#fafafa;"></div>
              </div>

              <div class="form-row">
                <div class="label">ã‚³ãƒ¼ã‚¹</div>
                <select class="select" id="courseSelect">
                  <option value="30">30åˆ†ã‚³ãƒ¼ã‚¹</option>
                  <option value="60" selected>1æ™‚é–“ã‚³ãƒ¼ã‚¹</option>
                  <option value="90">1æ™‚é–“30åˆ†ã‚³ãƒ¼ã‚¹</option>
                  <option value="120">2æ™‚é–“ã‚³ãƒ¼ã‚¹</option>
                  <option value="150">2æ™‚é–“30åˆ†ã‚³ãƒ¼ã‚¹</option>
                </select>
              </div>

              <div class="form-row">
                <div class="label">æ™‚é–“</div>
                <select class="select" id="timeSelect" disabled>
                  <option value="">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
                <div class="hint" id="timeHint"></div>
              </div>

              <div class="form-row">
                <div class="label">äººæ•°</div>
                <select class="select" id="countSelect">
                  <option value="1">1å</option><option value="2" selected>2å</option><option value="3">3å</option>
                  <option value="4">4å</option><option value="5">5å</option><option value="6">6å</option>
                  <option value="7">7å</option><option value="8">8å</option><option value="9">9å</option>
                  <option value="10">10å</option>
                </select>
              </div>

              <button class="btn-primary" type="button" id="openReserveBtn" disabled>
                ç©ºå¸­ç¢ºèªãƒ»äºˆç´„ã™ã‚‹
              </button>
            </div>
          </div>

        </div>

          <!-- ====== ãƒ¢ãƒ¼ãƒ€ãƒ« + ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆPOSTï¼‰====== -->
          <div class="modal-backdrop" id="modalBackdrop"></div>
          <div class="modal" id="reserveModal" role="dialog" aria-modal="true">
            <div class="modal-head">
              <div class="modal-title">äºˆç´„å†…å®¹ã®å…¥åŠ›</div>
              <button class="modal-close" type="button" id="modalCloseBtn">Ã—</button>
            </div>

            <form method="post" action="{% url 'stores:customer_reserve_create' store.pk %}" id="reserveForm">
              {% csrf_token %}
              <div class="modal-body">
                <input type="hidden" name="visit_date" id="visitDateInput">
                <input type="hidden" name="visit_time" id="visitTimeInput">
                <input type="hidden" name="visit_count" id="visitCountInput" value="2">
                <input type="hidden" name="course_minutes" id="courseMinutesInput" value="60">

                <div class="row2">
                  <div class="form-row">
                    <div class="label">æ—¥ä»˜</div>
                    <div class="input" id="confirmDate" style="background:#fafafa;"></div>
                  </div>
                  <div class="form-row">
                    <div class="label">æ™‚é–“</div>
                    <div class="input" id="confirmTime" style="background:#fafafa;"></div>
                  </div>
                </div>

                <div class="row2">
                  <div class="form-row">
                    <div class="label">ã‚³ãƒ¼ã‚¹</div>
                    <div class="input" id="confirmCourse" style="background:#fafafa;"></div>
                  </div>
                  <div class="form-row">
                    <div class="label">äººæ•°</div>
                    <div class="input" id="confirmCount" style="background:#fafafa;"></div>
                  </div>
                </div>

                <div style="margin:14px 0 8px;font-weight:bold;">äºˆç´„è€…æƒ…å ±</div>

                <div class="form-row">
                  <div class="label">æ°å</div>
                  <input class="input" name="full_name" value="{{ reservator_initial.full_name|default:'' }}" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ">
                </div>

                <div class="form-row">
                  <div class="label">æ°åï¼ˆã‹ãªï¼‰</div>
                  <input class="input" name="full_name_kana" value="{{ reservator_initial.full_name_kana|default:'' }}" placeholder="ä¾‹ï¼‰ã‚„ã¾ã  ãŸã‚ã†">
                </div>

                <div class="row2">
                  <div class="form-row">
                    <div class="label">ãƒ¡ãƒ¼ãƒ«</div>
                    <input class="input" name="email" value="{{ reservator_initial.email|default:'' }}" placeholder="example@mail.com">
                  </div>
                  <div class="form-row">
                    <div class="label">é›»è©±ç•ªå·</div>
                    <input class="input" name="phone_number" value="{{ reservator_initial.phone_number|default:'' }}" placeholder="090-xxxx-xxxx">
                  </div>
                </div>

                <div class="form-row">
                  <div class="label">å‚™è€ƒï¼ˆä»»æ„ï¼‰</div>
                  <textarea class="input" name="note" rows="3" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã©"></textarea>
                </div>

                <div class="hint">
                  â€» å–¶æ¥­æ™‚é–“å¤–ãƒ»å–¶æ¥­æ™‚é–“ã‚’è·¨ãäºˆç´„ã¯è¡¨ç¤ºã•ã‚Œãªã„ï¼é€ä¿¡ã—ã¦ã‚‚ã‚µãƒ¼ãƒå´ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚
                </div>
              </div>

              <div class="modal-foot">
                <button class="btn-sub" type="submit" id="submitBtn">ã“ã®å†…å®¹ã§äºˆç´„ã™ã‚‹</button>
              </div>
            </form>
          </div>

          <script>
          (function(){
            const grid = document.getElementById("calGrid");
            const panel = document.getElementById("reservePanel");

            const selectedDateLabel = document.getElementById("selectedDateLabel");
            const courseSelect = document.getElementById("courseSelect");
            const timeSelect = document.getElementById("timeSelect");
            const timeHint = document.getElementById("timeHint");
            const countSelect = document.getElementById("countSelect");
            const openReserveBtn = document.getElementById("openReserveBtn");

            const visitDateInput = document.getElementById("visitDateInput");
            const visitTimeInput = document.getElementById("visitTimeInput");
            const visitCountInput = document.getElementById("visitCountInput");
            const courseMinutesInput = document.getElementById("courseMinutesInput");

            const backdrop = document.getElementById("modalBackdrop");
            const modal = document.getElementById("reserveModal");
            const modalCloseBtn = document.getElementById("modalCloseBtn");

            const confirmDate = document.getElementById("confirmDate");
            const confirmTime = document.getElementById("confirmTime");
            const confirmCourse = document.getElementById("confirmCourse");
            const confirmCount = document.getElementById("confirmCount");

            const timeSlotsUrlBase = "{% url 'stores:time_slots_json' store.pk %}";

            let selectedDateIso = "";

            function clearSelected(){
              grid.querySelectorAll(".cal-cell.is-selected").forEach(el => el.classList.remove("is-selected"));
            }

            function setTimeSelectLoading(msg){
              timeSelect.innerHTML = `<option value="">${msg}</option>`;
              timeSelect.disabled = true;
              openReserveBtn.disabled = true;
            }

            function setTimeSelectOptions(slots){
              timeSelect.innerHTML =
                `<option value="">æ™‚é–“ã‚’é¸æŠ</option>` +
                slots.map(s => `<option value="${s}">${s}</option>`).join("");
              timeSelect.disabled = false;
            }

            async function loadSlots(){
              if(!selectedDateIso) return;

              const courseMinutes = courseSelect.value;
              setTimeSelectLoading("èª­ã¿è¾¼ã¿ä¸­...");

              const url = `${timeSlotsUrlBase}?date=${encodeURIComponent(selectedDateIso)}&course_minutes=${encodeURIComponent(courseMinutes)}`;

              try{
                const res = await fetch(url, {headers: {"X-Requested-With":"XMLHttpRequest"}});
                const data = await res.json();

                if(!data.ok){
                  setTimeSelectLoading(data.error || "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
                  timeHint.textContent = "";
                  return;
                }

                const slots = data.slots || [];
                if(slots.length === 0){
                  setTimeSelectLoading("å€™è£œãªã—");
                  timeHint.textContent = data.reason ? `ç†ç”±: ${data.reason}` : "äºˆç´„ã§ãã‚‹æ™‚é–“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
                  return;
                }

                setTimeSelectOptions(slots);
                timeHint.textContent = "";
              }catch(e){
                setTimeSelectLoading("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
                timeHint.textContent = "é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
              }
            }

            function openModal(){
              visitDateInput.value = selectedDateIso;
              visitTimeInput.value = timeSelect.value;
              visitCountInput.value = countSelect.value;
              courseMinutesInput.value = courseSelect.value;

              confirmDate.textContent = selectedDateIso;
              confirmTime.textContent = timeSelect.value;
              confirmCount.textContent = `${countSelect.value}å`;
              confirmCourse.textContent = courseSelect.options[courseSelect.selectedIndex].textContent;

              backdrop.style.display = "block";
              modal.style.display = "block";
            }

            function closeModal(){
              backdrop.style.display = "none";
              modal.style.display = "none";
            }

            grid.addEventListener("click", (e) => {
              const cell = e.target.closest(".cal-cell");
              if(!cell) return;

              // å½“æœˆå¤–ã¯ç„¡åŠ¹
              if(cell.dataset.inMonth === "0") return;

              // openæ—¥ä»¥å¤–ã¯ç„¡åŠ¹ï¼ˆdisabledæ‰±ã„ï¼‰
              if(!cell.classList.contains("is-open")) return;
              if(cell.classList.contains("is-disabled")) return;

              clearSelected();
              cell.classList.add("is-selected");

              selectedDateIso = cell.dataset.iso || "";
              selectedDateLabel.textContent = selectedDateIso;

              panel.style.display = "block";
              setTimeSelectLoading("æ™‚é–“å€™è£œã‚’å–å¾—ã—ã¾ã™...");
              loadSlots();
            });

            courseSelect.addEventListener("change", () => loadSlots());

            timeSelect.addEventListener("change", () => {
              openReserveBtn.disabled = !timeSelect.value;
            });

            openReserveBtn.addEventListener("click", () => {
              if(!selectedDateIso) return;
              if(!timeSelect.value) return;
              openModal();
            });

            backdrop.addEventListener("click", closeModal);
            modalCloseBtn.addEventListener("click", closeModal);
            document.addEventListener("keydown", (e) => {
              if(e.key === "Escape") closeModal();
            });
          })();
          </script>

        {% else %}
        <p style="font-size:12px;color:#999;">
          â€» ã“ã®åº—èˆ—ã¯ãƒãƒƒãƒˆäºˆç´„ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“
        </p>
        {% endif %}

      </div>
    </aside>

  </div>
</div>
{% endblock %}
