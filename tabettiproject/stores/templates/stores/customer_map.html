{% extends "customer_base.html" %}

{% block title %}åº—èˆ—ãƒãƒƒãƒ—æ¤œç´¢{% endblock %}

{% block css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    body { background-color: #fff; margin: 0; padding: 0; }
    .tabelog-wrapper {
        font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        color: #333; min-width: 1120px; max-width: 1400px; margin: 0 auto; padding: 0 10px;
    }
    .header-section { background-color: #f7f6f5; padding: 24px 20px; margin: 0 -10px; border-bottom: 1px solid #e6e6e6; }
    .main-heading { font-size: 22px; font-weight: bold; margin: 0; }
    .stats-bar { padding: 12px 0; border-bottom: 1px solid #eee; }
    #loading-status { font-size: 12px; color: #e67e22; font-weight: bold; }

    /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .main-content { display: flex; border: 1px solid #ddd; height: 600px; margin-top: 10px; }
    .side-list { width: 320px; overflow-y: auto; border-right: 1px solid #ddd; background: #fff; }
    .map-area { flex: 1; background-color: #e5e3df; }
    
    /* åº—èˆ—ã‚«ãƒ¼ãƒ‰ï¼ˆãƒªãƒ³ã‚¯ï¼‰ */
    .shop-link { text-decoration: none; color: inherit; display: block; }
    .shop-card { padding: 15px; border-bottom: 1px solid #eee; display: flex; gap: 12px; transition: background 0.2s; }
    .shop-card:hover { background: #fdf5ee; }
    .shop-img { width: 80px; height: 80px; background: #f0f0f0; flex-shrink: 0; border: 1px solid #eee; border-radius: 4px; }
    .shop-name { font-weight: bold; color: #06c; font-size: 14px; margin-bottom: 4px; }
    .shop-genre { font-size: 11px; color: #e67e22; font-weight: bold; }
    .shop-info { font-size: 11px; color: #666; margin-top: 2px; }
</style>
{% endblock %}

{% block content %}
<div class="tabelog-wrapper">
    <header class="header-section">
        <h1 class="main-heading">å‘¨è¾ºã®åº—èˆ—ã‚’åœ°å›³ã‹ã‚‰æ¢ã™</h1>
    </header>

    <div class="stats-bar">
        <div id="loading-status">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</div>
    </div>

    <div class="main-content">
        <aside class="side-list" id="shop-list-container">
            <div style="padding:20px; color:#999; text-align:center;">ç¾åœ¨åœ°å‘¨è¾ºã®åº—èˆ—ã‚’æ¤œç´¢ä¸­...</div>
        </aside>
        <main class="map-area" id="map-element"></main>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. åœ°å›³åˆæœŸåŒ–
    const map = L.map('map-element').setView([35.6812, 139.7671], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // 2. ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
    const currentPosIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', 
        iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
    });
    const bluePinIcon = L.icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    // 3. ã€é‡è¦ã€‘Djangoãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®åº—èˆ—ãƒªã‚¹ãƒˆï¼ˆURLã‚’è‡ªå‹•ç”Ÿæˆï¼‰
    const myShopList = [
        {% for shop in stores %}
        {
            // åå‰ç©ºé–“ 'stores' ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã‚’æƒ³å®š
            // ã‚‚ã—ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ 'stores:customer_store_info' ã‚’ 'customer_store_info' ã«å¤‰æ›´ã—ã¦ãã ã•ã„
            detailUrl: "{% url 'stores:customer_store_info' shop.pk %}",
            name: "{{ shop.store_name|escapejs }}{% if shop.branch_name %} {{ shop.branch_name|escapejs }}{% endif %}",
            address: "{{ shop.address|escapejs }}",
            genre: "{{ shop.genre|escapejs }}",
            hours: "{{ shop.business_hours|escapejs }}",
            phone: "{{ shop.phone_number|escapejs }}",
            lat: {% if shop.latitude %}{{ shop.latitude }}{% else %}null{% endif %},
            lng: {% if shop.longitude %}{{ shop.longitude }}{% else %}null{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // åº§æ¨™ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    function isValidLatLng(lat, lng) {
        if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) return false;
        if (lat < -90 || lat > 90) return false;
        if (lng < -180 || lng > 180) return false;
        return true;
    }

    if (navigator.geolocation) {
        if (!navigator.onLine) {
            document.getElementById('loading-status').innerHTML = '<span style="color:red;">æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçŠ¶æ³ã‚’ã”ç¢ºèªã—ã¦ãã ã•ã„</span>';
        } else {
            navigator.geolocation.getCurrentPosition(onSuccess, onError);
        }
    } else {
        document.getElementById('loading-status').innerText = "ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚";
    }

    async function onSuccess(position) {
        if (!navigator.onLine) {
            document.getElementById('loading-status').innerHTML = '<span style="color:red;">æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçŠ¶æ³ã‚’ã”ç¢ºèªã—ã¦ãã ã•ã„</span>';
            return;
        }

        // ä½ç½®æƒ…å ±å–å¾—å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        document.getElementById('loading-status').innerText = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸã€‚å‘¨è¾ºã®åº—èˆ—ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™...";

        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;

        if (!isValidLatLng(userLat, userLng)) {
            document.getElementById('loading-status').innerHTML = '<span style="color:red;">ä¸æ­£ãªä½ç½®æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚</span>';
            return;
        }

        const userLatLng = L.latLng(userLat, userLng);

        L.marker(userLatLng, {icon: currentPosIcon}).addTo(map).bindPopup("<b>ã‚ãªãŸã®ç¾åœ¨åœ°</b>");

        // åŠå¾„2kmã®ã‚µãƒ¼ã‚¯ãƒ«ã‚’æç”»
        const searchCircle = L.circle(userLatLng, {
            color: '#ff8a00',
            fillColor: '#ff8a00',
            fillOpacity: 0.1,
            radius: 2000
        }).addTo(map);

        // å††ãŒå…¨ä½“å…¥ã‚‹ã‚ˆã†ã«è¡¨ç¤ºèª¿æ•´
        map.fitBounds(searchCircle.getBounds());

        const listContainer = document.getElementById('shop-list-container');
        let foundCount = 0;
        let sideContent = '';

        for (const shop of myShopList) {
            if (!navigator.onLine) break;

            try {
                let sLat, sLng;

                // DBã«åº§æ¨™ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã† (é«˜é€ŸåŒ–)
                if (shop.lat !== null && shop.lng !== null) {
                    sLat = shop.lat;
                    sLng = shop.lng;
                } else {
                    // åº§æ¨™ãŒãªã„å ´åˆã¯APIã§å–å¾— (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
                    if (!navigator.onLine) break;
                    
                    const res = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(shop.address)}`);
                    if (!res.ok) throw new Error("Network response was not ok");
                    
                    const data = await res.json();
                    if (data && data.length > 0) {
                        sLat = data[0].geometry.coordinates[1];
                        sLng = data[0].geometry.coordinates[0];
                    } else {
                        console.warn(`ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ${shop.name}`);
                        continue;
                    }
                    await new Promise(r => setTimeout(r, 70));
                }

                if (!isValidLatLng(sLat, sLng)) continue;

                const shopLatLng = L.latLng(sLat, sLng);
                const distance = userLatLng.distanceTo(shopLatLng);

                // åŠå¾„2kmä»¥å†…ã®åˆ¤å®š
                if (distance <= 2000) {
                    foundCount++;

                    // åœ°å›³ã®ãƒ”ãƒ³
                    L.marker(shopLatLng, {icon: bluePinIcon}).addTo(map)
                        .bindPopup(`
                            <div style="min-width:150px;">
                                <div style="font-weight:bold; color:#06c;">${shop.name}</div>
                                <div style="font-size:11px; color:#e67e22; margin-bottom:5px;">${shop.genre}</div>
                                <a href="${shop.detailUrl}" style="color:#06c; text-decoration:none; font-size:12px; font-weight:bold;">â–¶ è©³ç´°ã‚’è¦‹ã‚‹</a>
                            </div>
                        `);

                    // å·¦å´ã®ã‚«ãƒ¼ãƒ‰
                    sideContent += `
                        <a href="${shop.detailUrl}" class="shop-link">
                            <article class="shop-card">
                                <div class="shop-img"></div>
                                <div>
                                    <div class="shop-genre">${shop.genre}</div>
                                    <div class="shop-name">${shop.name}</div>
                                    <div class="shop-info">ğŸ•’ ${shop.hours}</div>
                                    <div class="shop-info">ğŸ“ ${shop.phone}</div>
                                    <div style="font-size:10px; color:#999; margin-top:5px;">ğŸ“ ç¾åœ¨åœ°ã‹ã‚‰ ç´„${Math.round(distance)}m</div>
                                </div>
                            </article>
                        </a>`;
                }
            } catch (e) { 
                console.error("Shop processing error:", e);
            }
        }
        
        // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ä¸€æ‹¬æ›´æ–°
        listContainer.innerHTML = sideContent || '<div style="padding:20px; color:#999; text-align:center;">è¿‘ãã«åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        
        if (navigator.onLine) {
            const msg = foundCount > 0 ? `2kmåœå†…ã« ${foundCount} ä»¶ã®åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ` : "è¿‘ãã«åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            document.getElementById('loading-status').innerHTML = `<span style="font-weight:bold; color:#0056b3;">${msg}</span>`;
        }
    }

    function onError(error) { 
        if (!navigator.onLine) {
            document.getElementById('loading-status').innerHTML = '<span style="color:red;">æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçŠ¶æ³ã‚’ã”ç¢ºèªã—ã¦ãã ã•ã„</span>';
        } else {
            document.getElementById('loading-status').innerText = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; 
        }
    }
</script>
{% endblock %}