{% extends "customer_base.html" %}

{% block title %}{{ store.store_name }} - å†™çœŸ{% endblock %}

{% block css %}
<style>
.shop-main{max-width:1000px;margin:0 auto;background:#fff;border:1px solid #e6e6e6;color:#333;font-family:"Hiragino Kaku Gothic ProN","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;}

.photo-section{padding:20px;}
.upload-area{margin-bottom:30px;text-align:center;padding:30px;background:#f9f9f9;border-radius:10px;border:2px dashed #ddd;}
.upload-btn{display:inline-block;padding:14px 30px;background:#ff6600;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:15px;}
.upload-btn:hover{opacity:.9;}

.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:20px;}
.photo-item{position:relative;aspect-ratio:1;overflow:hidden;border-radius:8px;border:1px solid #eee;cursor:pointer;transition:transform .2s;}
.photo-item:hover{transform:scale(1.05);}
.photo-item img{width:100%;height:100%;object-fit:cover;}
.photo-info{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.7));color:#fff;padding:8px;font-size:11px;}

/* Lightbox */
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10000;align-items:center;justify-content:center;}
.lightbox.active{display:flex;}
.lightbox img{max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;}
.lightbox-close{position:absolute;top:20px;right:30px;font-size:40px;color:#fff;cursor:pointer;font-weight:bold;}
.lightbox-close:hover{opacity:.7;}

/* Upload Modal */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;}
.modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(560px,92vw);background:#fff;border-radius:14px;z-index:9999;border:1px solid #eee;box-shadow:0 10px 30px rgba(0,0,0,.25);}
.modal-head{padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
.modal-title{font-weight:bold;}
.modal-close{border:none;background:transparent;font-size:18px;cursor:pointer;}
.modal-body{padding:14px 16px;}
.modal-foot{padding:14px 16px;border-top:1px solid #eee;}
.form-row{margin:10px 0;}
.label{font-size:12px;color:#555;margin-bottom:6px;}
.input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px;background:#fff;}
.hint{font-size:11px;color:#888;margin-top:6px;line-height:1.4;}
.btn-sub{width:100%;background:#222;color:#fff;border:none;border-radius:10px;font-weight:bold;padding:14px;cursor:pointer;}
.btn-sub:disabled{opacity:.5;cursor:not-allowed;}
</style>
{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumbs">
  <ol>
    <li><a href="{% url 'accounts:customer_top' %}">ãƒˆãƒƒãƒ—</a></li>
    <li><span>{{ store.store_name }}</span></li>
    <li><span>å†™çœŸ</span></li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="shop-main">
  {% include "stores/_customer_store_common.html" with store=store is_saved=is_saved star_states=star_states avg_rating=avg_rating review_count=review_count active_main="photos" %}

  <div class="photo-section">
    {% if user.is_authenticated %}
    <div class="upload-area">
      <p style="margin:0 0 12px;font-size:14px;color:#666;">ã“ã®åº—èˆ—ã®å†™çœŸã‚’æŠ•ç¨¿ã—ã¾ã—ã‚‡ã†ï¼</p>
      <button class="upload-btn" type="button" onclick="openUploadModal()">ğŸ“· å†™çœŸã‚’æŠ•ç¨¿ã™ã‚‹</button>
    </div>
    {% else %}
    <div class="upload-area">
      <p style="margin:0;font-size:14px;color:#666;">å†™çœŸã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯<a href="{% url 'accounts:customer_login' %}" style="color:#ff6600;font-weight:bold;">ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
    {% endif %}

    <div class="photo-grid">
      {% for img in store_images %}
      {% if img.image_file %}
      <div class="photo-item" onclick="openLightbox('{{ img.image_file.url }}')">
        <img src="{{ img.image_file.url }}" alt="{{ store.store_name }}">
        <div class="photo-info">
          {% if img.uploaded_by %}
          æŠ•ç¨¿è€…: {{ img.uploaded_by.username }}
          {% else %}
          åº—èˆ—å…¬å¼
          {% endif %}
        </div>
      </div>
      {% endif %}
      {% empty %}
      <p style="grid-column:1/-1;text-align:center;color:#999;padding:40px 0;">ã¾ã å†™çœŸãŒæŠ•ç¨¿ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
  <img id="lightboxImg" src="" alt="">
</div>

<!-- Upload Modal -->
<div class="modal-backdrop" id="uploadBackdrop"></div>
<div class="modal" id="uploadModal" role="dialog" aria-modal="true">
  <div class="modal-head">
    <div class="modal-title">å†™çœŸã‚’æŠ•ç¨¿</div>
    <button class="modal-close" type="button" onclick="closeUploadModal()">&times;</button>
  </div>
  <form method="post" action="{% url 'stores:customer_store_photo_upload' store.pk %}" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="modal-body">
      <div class="form-row">
        <div class="label">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</div>
        <input type="file" name="photo" accept="image/*" required class="input">
      </div>
      <div class="hint">JPGã€PNGå½¢å¼ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</div>
    </div>
    <div class="modal-foot">
      <button class="btn-sub" type="submit">æŠ•ç¨¿ã™ã‚‹</button>
    </div>
  </form>
</div>

<script>
function openLightbox(src) {
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('active');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('active');
}

function openUploadModal() {
  document.getElementById('uploadBackdrop').style.display = 'block';
  document.getElementById('uploadModal').style.display = 'block';
}

function closeUploadModal() {
  document.getElementById('uploadBackdrop').style.display = 'none';
  document.getElementById('uploadModal').style.display = 'none';
}

document.getElementById('uploadBackdrop').addEventListener('click', closeUploadModal);
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeLightbox();
    closeUploadModal();
  }
});
</script>
{% endblock %}
