{% extends 'company_base.html' %}

{% block content %}
<style>
    /* 1. å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .report-wrapper {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
        font-family: sans-serif;
    }

    .page-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
        border-left: 5px solid #ff9600; 
        padding-left: 15px;
    }

    /* â‘¡ å ±å‘Šã‚«ãƒ¼ãƒ‰ã®ã‚°ãƒªãƒƒãƒ‰é…ç½® */
    .report-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; 
        gap: 25px; 
        margin-bottom: 50px;
    }

    .report-card {
        border: 2px solid #333;
        background-color: #fff;
        padding: 20px;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        cursor: pointer; 
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .report-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #ff9600;
    }

    .user-name {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }

    .report-summary {
        text-align: right;
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }

    /* â‘  æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .btn-back {
        padding: 10px 40px;
        border: 2px solid #333;
        background-color: #fff;
        color: #000;
        text-decoration: none;
        font-weight: bold;
        font-size: 16px;
        display: inline-block;
    }

    /* --- JSç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ --- */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: #fff;
        padding: 30px;
        border: 2px solid #333;
        border-radius: 15px;
        width: 550px;
        max-width: 90%;
    }

    .modal-header {
        font-weight: bold;
        font-size: 20px;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    /* ğŸŒŸ å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-delete-review {
        padding: 8px 20px;
        border: 2px solid #d9534f;
        background-color: #fff;
        color: #d9534f;
        text-decoration: none;
        font-weight: bold;
        border-radius: 8px;
        font-size: 14px;
    }
    .btn-delete-review:hover {
        background-color: #d9534f;
        color: #fff;
    }

    .modal-footer {
        margin-top: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
    .sa-pager {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 14px;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .sa-link {
        color: #1e73c9;
        text-decoration: none;
        font-size: 13px;
    }

    .sa-link:hover {
        text-decoration: underline;
    }

    .sa-link-disabled {
        color: #aaa;
        pointer-events: none;
        text-decoration: none;
        font-size: 13px;
    }

    .sa-pageinfo {
        font-size: 12px;
        color: #666;
    }
</style>

<div class="report-wrapper">
    <h1 class="page-title">å ±å‘Šç®¡ç†</h1>

    <div class="filter-section" style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
        <form method="get" id="filter-form">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold; color: #555;">
                <input type="checkbox" name="pending" value="1" 
                       {% if only_pending %}checked{% endif %}
                       onchange="document.getElementById('hidden-pending').value = this.checked ? '1' : '0'; this.form.submit();">
                <span>æœªå‡¦ç†ã®ã¿è¡¨ç¤º</span>
                <input type="hidden" name="pending" id="hidden-pending" value="{% if only_pending %}1{% else %}0{% endif %}">
            </label>
        </form>
    </div>

    <div class="report-grid">
        {% for report in reports %}
        <!-- ğŸŒŸ ç¬¬3å¼•æ•°ã« review.id ã‚’è¿½åŠ  -->
        <div class="report-card" 
             onclick="openReport('{{ report.reporter.username }}', '{{ report.report_text|escapejs }}', '{{ report.review.id }}')">
            <div class="user-name">é€šå ±è€…ï¼š{{ report.reporter.username }}</div>
            <div class="report-summary">
                å¯¾è±¡å£ã‚³ãƒŸID: {{ report.review.id }}<br>
                å†…å®¹ï¼š{{ report.report_text|truncatechars:30 }}
            </div>
        </div>
        {% empty %}
            <p>å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endfor %}
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    {% if reports and reports.has_other_pages %}
    <div class="sa-pager">
      {% if reports.has_previous %}
      <a class="sa-link" href="?pending={% if only_pending %}1{% else %}0{% endif %}&page={{ reports.previous_page_number }}">å‰ã¸</a>
      {% else %}
      <span class="sa-link sa-link-disabled">å‰ã¸</span>
      {% endif %}

      <span class="sa-pageinfo">Page {{ reports.number }} / {{ reports.paginator.num_pages }}</span>

      {% if reports.has_next %}
      <a class="sa-link" href="?pending={% if only_pending %}1{% else %}0{% endif %}&page={{ reports.next_page_number }}">æ¬¡ã¸</a>
      {% else %}
      <span class="sa-link sa-link-disabled">æ¬¡ã¸</span>
      {% endif %}
    </div>
    {% endif %}

    <div class="footer-actions">
        <a href="{% url 'accounts:company_top' %}" class="btn-back">æˆ»ã‚‹</a>
    </div>
</div>

<!-- è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-content">
        <div class="modal-header" id="modalUserName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div>
        <p id="modalFullContent">å ±å‘Šå†…å®¹ã®è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        
        <div class="modal-footer">
            <!-- ğŸŒŸ å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆãƒªãƒ³ã‚¯ã¯JSã§å‹•çš„ã«æ›¸ãæ›ãˆã¾ã™ï¼‰ -->
            <a href="#" id="deleteReviewBtn" class="btn-delete-review">ğŸš© å£ã‚³ãƒŸã‚’å‰Šé™¤ã™ã‚‹</a>
            
            <button onclick="closeReport()" style="padding: 8px 25px; cursor: pointer; font-weight: bold; border: 1px solid #ccc; background: #fff;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
  function openReport(name, content, reviewId) {
    document.getElementById('modalUserName').innerText = name + " ã‹ã‚‰ã®å ±å‘Š";
    document.getElementById('modalFullContent').innerText = content;

    // å‰Šé™¤å®Ÿè¡ŒURLï¼ˆDjangoã«ä½œã‚‰ã›ã‚‹ï¼‰
    let deletePattern = "{% url 'reviews:review_delete_execute' 0 %}";
    const deleteExecUrl = deletePattern.replace("0", reviewId);

    // ğŸŒŸ é‹ç”¨å…±é€šç¢ºèªç”»é¢ã®URL
    const confirmUrl = "{% url 'commons:company_common_confirm' %}";
    
    // ğŸŒŸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’ã€Œconfirm_messageã€ã«åˆã‚ã›ã‚‹
    const message = encodeURIComponent("ã“ã®ä¸é©åˆ‡ãªå£ã‚³ãƒŸã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
    const finalUrl = `${confirmUrl}?confirm_message=${message}&next_url=${deleteExecUrl}`;
    
    document.getElementById('deleteReviewBtn').href = finalUrl;
    document.getElementById('reportModal').style.display = 'flex';
}

function closeReport() {
    document.getElementById('reportModal').style.display = 'none';
}

// èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
window.onclick = function(event) {
    let modal = document.getElementById('reportModal');
    if (event.target == modal) {
        closeReport();
    }
}
</script>
{% endblock %}