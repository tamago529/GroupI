{% extends "customer_base.html" %}

{% block title %}å£ã‚³ãƒŸä¸€è¦§ - {{ shop.store_name }}{% endblock %}

{% block css %}
<style>
    /* --- 1. å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .shop-container {
        max-width: 980px;
        margin: 20px auto;
        font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
        color: #333;
        line-height: 1.6;
    }

    /* --- 2. ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šå…¬å¼ãƒãƒƒã‚¸ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ --- */
    .header-upper-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .official-label {
        background-color: #bfa67b;
        color: #fff;
        padding: 2px 8px;
        font-size: 12px;
        border-radius: 2px;
        font-weight: bold;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-action {
        border: 1px solid #ccc;
        background: #fff;
        padding: 6px 14px;
        font-size: 13px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-post {
        background-color: #93c02d;
        color: #fff;
        border: none;
        font-weight: bold;
    }

    /* --- 3. åº—èˆ—ãƒ¡ã‚¤ãƒ³æƒ…å ±ï¼ˆåº—åãƒ»è©•ä¾¡ï¼‰ --- */
    .shop-main-info {
        margin-bottom: 20px;
    }

    .catchphrase {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }

    .shop-title {
        font-size: 26px;
        font-weight: bold;
        margin: 0 0 10px 0;
    }

    .rating-flex {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .star-rating {
        position: relative;
        display: inline-block;
        font-size: 22px;
        line-height: 1;
    }

    .star-rating-back { color: #ccc; }
    .star-rating-front {
        position: absolute;
        top: 0; left: 0;
        overflow: hidden;
        white-space: nowrap;
        color: #ff9800;
        width: var(--rating-percent, 0%);
    }

    .score-red {
        font-size: 28px;
        font-weight: bold;
        color: #e60012;
    }

    /* --- 4. ã‚¹ãƒšãƒƒã‚¯æƒ…å ± --- */
    .spec-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }

    .spec-item { margin-bottom: 5px; }
    .spec-label { color: #666; width: 80px; display: inline-block; }

    .detail-link {
        color: #06c;
        text-decoration: none;
        font-size: 11px;
    }

    /* --- 5. ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
    .shop-tabs {
        display: flex;
        border: 1px solid #ddd;
        background-color: #fff;
        margin-bottom: 20px;
    }

    .tab-item {
        flex: 1;
        text-align: center;
        padding: 15px 0;
        border-right: 1px solid #ddd;
        font-size: 15px;
        font-weight: bold;
        text-decoration: none;
        color: #333;
    }

    .tab-item:last-child { border-right: none; }
    .tab-item.active {
        background-color: #8c8366;
        color: #fff;
    }

    /* --- 6. å£ã‚³ãƒŸæ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ --- */
    .review-filter-section {
        background-color: #f9f9f7;
        padding: 20px;
        border: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .search-box-container {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #fff;
        padding: 15px;
        border: 1px solid #ccc;
        margin-bottom: 20px;
    }

    .search-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
    }

    .search-button {
        background-color: #93c02d;
        color: #fff;
        border: none;
        padding: 8px 25px;
        font-weight: bold;
        cursor: pointer;
    }

    .filter-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
    }

    .filter-tab-item {
        flex: 1;
        text-align: center;
        padding: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-bottom: none;
        font-size: 14px;
        text-decoration: none;
        color: #333;
    }

    .filter-tab-item.active {
        border-top: 2px solid #ff9800;
        color: #ff9800;
        font-weight: bold;
    }

    /* --- 7. ä¸¦ã³æ›¿ãˆãƒ»ä»¶æ•°è¡¨ç¤º --- */
    .list-header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #666;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }

    /* --- 8. å£ã‚³ãƒŸã‚«ãƒ¼ãƒ‰ --- */
    .review-card {
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 8px;
        background-color: #fff;
        margin-bottom: 20px;
    }

    .review-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .user-avatar { border-radius: 50%; object-fit: cover; background-color: #eee; }
    .review-title { font-weight: bold; font-size: 17px; margin: 12px 0; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-backdrop{
        position: fixed; inset: 0; background: rgba(0,0,0,.45);
        display:none; align-items:center; justify-content:center;
        z-index: 2000; padding: 18px;
    }
    .modal-backdrop.active{ display:flex; }
    .modal-card{
        width: 100%; max-width: 560px; background:#fff;
        border-radius: 10px; border:1px solid #e5e5e5;
        box-shadow: 0 12px 30px rgba(0,0,0,.18); overflow:hidden;
    }
    .modal-head{
        display:flex; justify-content: space-between; align-items:center;
        padding: 12px 14px; border-bottom: 1px solid #eee; background: #fafafa;
    }
    .modal-body{ padding: 14px; }
    .field{ margin-bottom: 12px; }
    .label{ font-size: 12px; color:#666; margin-bottom: 6px; display:block; }
    .time-slot{ display:flex; gap:10px; }
    .slot-btn{
        flex: 1; border: 1px solid #ddd; background:#fff; border-radius: 8px;
        padding: 10px 12px; cursor:pointer; display:flex; align-items:center;
        justify-content:center; gap:8px; font-weight:bold;
    }
    .slot-btn.active{ border-color:#93c02d; box-shadow: 0 0 0 2px rgba(147,192,45,.18); }
    .stars{ display:flex; gap:6px; align-items:center; font-size: 22px; }
    .star{ cursor:pointer; color:#ccc; }
    .star.filled{ color:#ff9800; }
    .text-input, .text-area{ width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 10px; font-size: 13px; box-sizing: border-box; }
    .text-area{ min-height: 120px; resize: vertical; }
    .modal-foot{ padding: 12px 14px; border-top: 1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fafafa; }
    .btn-primary{ background:#93c02d; color:#fff; border:none; padding: 8px 14px; border-radius: 6px; cursor:pointer; font-weight:bold; }

    .report-link {
    font-size: 12px;
    color: #999;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
}

.report-link:hover {
    color: #d9534f; /* é€šå ±ã£ã½ãèµ¤è‰²ã« */
    background-color: #fff5f5;
    text-decoration: underline;
}

</style>
{% endblock %}

{% block content %}
<article class="shop-container">

    <div class="header-upper-row">
        <div><span class="official-label">å…¬å¼</span></div>
        <div class="action-buttons">
            <button class="btn-action" type="button">è¡Œã£ãŸ</button>

            <!-- ä¿å­˜æ©Ÿèƒ½ -->
            <form method="post" action="." style="margin:0;">
                {% csrf_token %}
                <input type="hidden" name="action" value="save_store">
                <input type="hidden" name="store_id" value="{{ shop.id }}">
                <button class="btn-action" type="submit">
                    {% if is_saved %}â˜… ä¿å­˜æ¸ˆã¿{% else %}â˜† ä¿å­˜{% endif %}
                </button>
            </form>

            <button id="openPostModal" class="btn-action btn-post" type="button">æŠ•ç¨¿</button>
        </div>
    </div>

    <div class="shop-main-info">
        <!-- ğŸŒŸ ã‚­ãƒ£ãƒƒãƒãƒ•ãƒ¬ãƒ¼ã‚ºï¼ˆã‚¨ãƒªã‚¢ã¨ã‚·ãƒ¼ãƒ³ã‚’è¡¨ç¤ºï¼‰ -->
        <p class="catchphrase">{{ shop.area.area_name }} ï¼ åˆ©ç”¨ã‚·ãƒ¼ãƒ³ï¼š{{ shop.scene.scene_name }}</p>
        <!-- ğŸŒŸ åº—å -->
        <h1 class="shop-title">{{ shop.store_name }} {{ shop.branch_name }}</h1>

        <div class="rating-flex">
            
            <div class="star-rating" style="--rating-percent: {% widthratio review.score|default:0 5 100 %}%">
                <div class="star-rating-front">â˜…â˜…â˜…â˜…â˜…</div>
                <div class="star-rating-back">â˜…â˜…â˜…â˜…â˜…</div>
            </div>
            <span class="score-red">3.00</span>
            <span style="color: #06c; font-size: 13px;">{{ reviews.count }}äºº</span>
            <span style="color: #666; font-size: 13px;">ç™»éŒ²æ•°ï¼š{{ shop.save_count|default:0 }}äºº</span>
        </div>
    </div>

    <div class="shop-specs">
        <div class="spec-item">
            <span class="spec-label">ä½æ‰€ï¼š</span>
            <span>{{ shop.address }}</span>
        </div>
        <div class="spec-item">
            <span class="spec-label">ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</span>
            <span>{{ shop.scene.scene_name }}</span>
        </div>
        <div class="spec-row">
            <div>
                <span class="spec-label">äºˆç®—ï¼š</span>
                <span>ï¿¥{{ shop.budget|default:"-" }} ã€œ</span>
            </div>
            <a href="{% url 'stores:customer_store_info' shop.id %}" class="detail-link">åº—èˆ—æƒ…å ±ï¼ˆè©³ç´°ï¼‰</a>
        </div>
    </div>

    <nav class="shop-tabs">
        <a href="{% url 'stores:customer_store_info' shop.id %}" class="tab-item">ãƒˆãƒƒãƒ—</a>
        <a href="#" class="tab-item">åº§å¸­</a>
        <a href="{% url 'stores:customer_menu_course' shop.id %}" class="tab-item">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚³ãƒ¼ã‚¹</a>
        <a href="#" class="tab-item">å†™çœŸ</a>
        <a href="{% url 'reviews:customer_review_list' %}?store_id={{ shop.id }}" class="tab-item active">
    å£ã‚³ãƒŸ <span class="count-badge">{{ reviews.count }}</span>
</a>
        <a href="{% url 'stores:customer_map' %}" class="tab-item" style="color: #e60012;">ã‚¯ãƒ¼ãƒãƒ³ãƒ»åœ°å›³</a>
    </nav>

    <section class="review-filter-section">
        <div class="search-box-container">
            <label for="review-search" class="search-label">å£ã‚³ãƒŸæ¤œç´¢</label>
            <input type="text" id="review-search" class="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
            <button class="search-button">æ¤œç´¢</button>
        </div>

        <div class="filter-tabs">
            <a href="#" class="filter-tab-item active">ğŸ’¬ ã™ã¹ã¦ã®å£ã‚³ãƒŸ</a>
            <a href="#" class="filter-tab-item">ğŸŒ™ å¤œã®å£ã‚³ãƒŸ</a>
            <a href="#" class="filter-tab-item">â˜€ï¸ æ˜¼ã®å£ã‚³ãƒŸ</a>
        </div>

        <div class="list-header-info">
            <div>å…¨ <strong>{{ reviews.count }}</strong> ä»¶ã‚’è¡¨ç¤º</div>
        </div>
    </section>

    <!-- ğŸŒŸ å£ã‚³ãƒŸä¸€è¦§ã®ãƒ«ãƒ¼ãƒ— -->
    <section class="review-section">
        <div id="review-container">
            {% for review in reviews %}
            <article class="review-card">
                  <p style="font-size: 14px; line-height: 1.6; margin-top: 15px;">{{ review.review_text|linebreaksbr }}</p>

    <!-- ğŸŒŸ é€šå ±ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
    <div style="text-align: right; margin-top: 10px;">
        <a href="{% url 'reviews:customer_report_input' %}?review_id={{ review.pk }}" class="report-link">
            ğŸš© ã“ã®å£ã‚³ãƒŸã‚’é€šå ±ã™ã‚‹
        </a>
    </div>
                <div class="review-user-info">
                    <div style="width:40px; height:40px; background:#ddd; border-radius:50%; display:inline-block;"></div>
                    <div>
                        <div style="font-weight: bold;">{{ review.reviewer.nickname }} ã•ã‚“</div>
                        <div style="font-size: 12px; color: #666;">æŠ•ç¨¿æ—¥ï¼š{{ review.posted_at|date:"Y/m/d" }}</div>
                    </div>
                </div>
                <div class="star-rating" style="--rating-percent: {% widthratio review.score 5 100 %}%">
                    <div class="star-rating-front">â˜…â˜…â˜…â˜…â˜…</div>
                    <div class="star-rating-back">â˜…â˜…â˜…â˜…â˜…</div>
                    <span style="color: #e60012; font-weight: bold; font-size: 16px; margin-left: 10px;">{{ review.score|floatformat:1 }}</span>
                </div>
                <!-- ğŸŒŸ å£ã‚³ãƒŸæœ¬æ–‡ -->
                <p style="font-size: 14px; line-height: 1.6; margin-top: 15px;">{{ review.review_text|linebreaksbr }}</p>
            </article>
            {% empty %}
            <p style="text-align:center; padding: 40px; color:#999;">ç¾åœ¨ã€æŠ•ç¨¿ã•ã‚Œã¦ã„ã‚‹å£ã‚³ãƒŸã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        </div>
    </section>

</article>

<!-- æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="postModal" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">å£ã‚³ãƒŸã‚’æŠ•ç¨¿</div>
      <button id="closePostModal" class="modal-close" type="button">Ã—</button>
    </div>

    <form id="reviewPostForm" method="post" action=".">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_review">
      <input type="hidden" name="store_id" value="{{ shop.id }}">
      <input type="hidden" name="time_slot" id="timeSlotInput" value="">
      <input type="hidden" name="score" id="scoreInput" value="">

      <div class="modal-body">
        <div class="field">
          <span class="label">æ™‚é–“å¸¯</span>
          <div class="time-slot">
            <button type="button" class="slot-btn" data-slot="æ˜¼">â˜€ æ˜¼</button>
            <button type="button" class="slot-btn" data-slot="å¤œ">ğŸŒ™ å¤œ</button>
          </div>
        </div>

        <div class="field">
          <span class="label">è©•ä¾¡</span>
          <div class="stars" id="stars">
            <span class="star" data-v="1">â˜…</span>
            <span class="star" data-v="2">â˜…</span>
            <span class="star" data-v="3">â˜…</span>
            <span class="star" data-v="4">â˜…</span>
            <span class="star" data-v="5">â˜…</span>
            <span class="score-badge" id="scoreBadge">æœªé¸æŠ</span>
          </div>
        </div>

        <div class="field">
          <label class="label">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input class="text-input" type="text" name="title" maxlength="100" placeholder="ä¾‹ï¼‰ã¾ãŸè¡ŒããŸã„ï¼">
        </div>

        <div class="field">
          <label class="label">æœ¬æ–‡</label>
          <textarea class="text-area" name="body" placeholder="æ–™ç†ãƒ»é›°å›²æ°—ãƒ»æ¥å®¢ãªã©"></textarea>
        </div>

        <div class="agree-row">
          <input id="agreeCheck" type="checkbox" name="agree">
          <label for="agreeCheck">å†…å®¹ã«åŒæ„ã—ã¦æŠ•ç¨¿ã—ã¾ã™</label>
        </div>
      </div>

      <div class="modal-foot">
        <button id="cancelBtn" class="btn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="submitBtn" class="btn btn-primary" type="submit" disabled>åŒæ„ã—ã¦æŠ•ç¨¿</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById("postModal");
  const openBtn = document.getElementById("openPostModal");
  const closeBtn = document.getElementById("closePostModal");
  const cancelBtn = document.getElementById("cancelBtn");
  const slotBtns = modal.querySelectorAll(".slot-btn");
  const timeSlotInput = document.getElementById("timeSlotInput");
  const starsWrap = document.getElementById("stars");
  const stars = starsWrap.querySelectorAll(".star");
  const scoreInput = document.getElementById("scoreInput");
  const scoreBadge = document.getElementById("scoreBadge");
  const agree = document.getElementById("agreeCheck");
  const submitBtn = document.getElementById("submitBtn");

  function openModal(){ modal.classList.add("active"); }
  function closeModal(){ modal.classList.remove("active"); }
  function updateSubmitState(){
    submitBtn.disabled = !(agree.checked && timeSlotInput.value && scoreInput.value);
  }

  openBtn.addEventListener("click", openModal);
  closeBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);

  slotBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      slotBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      timeSlotInput.value = btn.dataset.slot;
      updateSubmitState();
    });
  });

  stars.forEach(s => {
    s.addEventListener("click", () => {
      const v = s.dataset.v;
      scoreInput.value = v;
      stars.forEach(star => {
          star.classList.toggle("filled", star.dataset.v <= v);
      });
      scoreBadge.textContent = v + " / 5";
      updateSubmitState();
    });
  });

  agree.addEventListener("change", updateSubmitState);
})();
</script>
{% endblock %}