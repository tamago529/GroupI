{% extends "customer_base.html" %}

{% block title %}å£ã‚³ãƒŸä¸€è¦§ - {{ shop.name }}{% endblock %}

{% block css %}
<style>
    /* --- 1. å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .shop-container {
        max-width: 980px;
        margin: 20px auto;
        font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
        color: #333;
        line-height: 1.6;
    }

    /* --- 2. ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šå…¬å¼ãƒãƒƒã‚¸ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ --- */
    .header-upper-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .official-label {
        background-color: #bfa67b;
        color: #fff;
        padding: 2px 8px;
        font-size: 12px;
        border-radius: 2px;
        font-weight: bold;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-action {
        border: 1px solid #ccc;
        background: #fff;
        padding: 6px 14px;
        font-size: 13px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-post {
        background-color: #93c02d;
        color: #fff;
        border: none;
        font-weight: bold;
    }

    /* --- 3. åº—èˆ—ãƒ¡ã‚¤ãƒ³æƒ…å ±ï¼ˆåº—åãƒ»è©•ä¾¡ï¼‰ --- */
    .shop-main-info {
        margin-bottom: 20px;
    }

    .catchphrase {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }

    .shop-title {
        font-size: 26px;
        font-weight: bold;
        margin: 0 0 10px 0;
    }

    .rating-flex {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .star-rating {
        position: relative;
        display: inline-block;
        font-size: 22px;
        line-height: 1;
    }

    .star-rating-back { color: #ccc; }
    .star-rating-front {
        position: absolute;
        top: 0; left: 0;
        overflow: hidden;
        white-space: nowrap;
        color: #ff9800;
        width: var(--rating-percent, 0%);
    }

    .score-red {
        font-size: 28px;
        font-weight: bold;
        color: #e60012;
    }

    /* --- 4. ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ï¼ˆèµ¤ã„å¢ƒç•Œç·šï¼‰ --- */

    .spec-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }

    .spec-item { margin-bottom: 5px; }
    .spec-label { color: #666; width: 80px; display: inline-block; }

    .detail-link {
        color: #06c;
        text-decoration: none;
        font-size: 11px;
    }

    /* --- 5. ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
    .shop-tabs {
        display: flex;
        border: 1px solid #ddd;
        background-color: #fff;
        margin-bottom: 20px;
    }

    .tab-item {
        flex: 1;
        text-align: center;
        padding: 15px 0;
        border-right: 1px solid #ddd;
        font-size: 15px;
        font-weight: bold;
        text-decoration: none;
        color: #333;
    }

    .tab-item:last-child { border-right: none; }
    .tab-item.active {
        background-color: #8c8366;
        color: #fff;
    }

    /* --- 6. å£ã‚³ãƒŸæ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ --- */
    .review-filter-section {
        background-color: #f9f9f7;
        padding: 20px;
        border: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .search-box-container {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #fff;
        padding: 15px;
        border: 1px solid #ccc;
        margin-bottom: 20px;
    }

    .search-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
    }

    .search-button {
        background-color: #93c02d;
        color: #fff;
        border: none;
        padding: 8px 25px;
        font-weight: bold;
        cursor: pointer;
    }

    .filter-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
    }

    .filter-tab-item {
        flex: 1;
        text-align: center;
        padding: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-bottom: none;
        font-size: 14px;
        text-decoration: none;
        color: #333;
    }

    .filter-tab-item.active {
        border-top: 2px solid #ff9800;
        color: #ff9800;
        font-weight: bold;
    }

    /* --- 7. ä¸¦ã³æ›¿ãˆãƒ»ä»¶æ•°è¡¨ç¤º --- */
    .list-header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #666;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }

    /* --- 8. å£ã‚³ãƒŸã‚«ãƒ¼ãƒ‰ --- */
    .review-card {
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 8px;
        background-color: #fff;
        margin-bottom: 20px;
    }

    .review-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .user-avatar { border-radius: 50%; object-fit: cover; }
    .review-title { font-weight: bold; font-size: 17px; margin: 12px 0; }
 /* -------------------------
       æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¿½åŠ ï¼‰
    ------------------------- */
    .modal-backdrop{
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        display:none;
        align-items:center;
        justify-content:center;
        z-index: 2000;
        padding: 18px;
    }
    .modal-backdrop.active{ display:flex; }

    .modal-card{
        width: 100%;
        max-width: 560px;
        background:#fff;
        border-radius: 10px;
        border:1px solid #e5e5e5;
        box-shadow: 0 12px 30px rgba(0,0,0,.18);
        overflow:hidden;
    }
    .modal-head{
        display:flex;
        justify-content: space-between;
        align-items:center;
        padding: 12px 14px;
        border-bottom: 1px solid #eee;
        background: #fafafa;
    }
    .modal-title{
        font-weight:bold;
        font-size: 14px;
    }
    .modal-close{
        border:none;
        background:transparent;
        font-size:18px;
        cursor:pointer;
        line-height:1;
    }
    .modal-body{
        padding: 14px;
    }
    .field{
        margin-bottom: 12px;
    }
    .label{
        font-size: 12px;
        color:#666;
        margin-bottom: 6px;
        display:block;
    }

    .time-slot{
        display:flex;
        gap:10px;
    }
    .slot-btn{
        flex: 1;
        border: 1px solid #ddd;
        background:#fff;
        border-radius: 8px;
        padding: 10px 12px;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        font-weight:bold;
    }
    .slot-btn.active{
        border-color:#93c02d;
        box-shadow: 0 0 0 2px rgba(147,192,45,.18);
    }

    .stars{
        display:flex;
        gap:6px;
        align-items:center;
        font-size: 22px;
        user-select:none;
    }
    .star{
        cursor:pointer;
        color:#ccc;
    }
    .star.filled{
        color:#ff9800;
    }
    .score-badge{
        margin-left:10px;
        font-size: 12px;
        color:#666;
    }

    .text-input, .text-area{
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px 10px;
        font-size: 13px;
        box-sizing: border-box;
    }
    .text-area{ min-height: 120px; resize: vertical; }

    .agree-row{
        display:flex;
        gap:8px;
        align-items:flex-start;
        font-size: 12px;
        color:#555;
        margin-top: 6px;
    }

    .modal-foot{
        padding: 12px 14px;
        border-top: 1px solid #eee;
        display:flex;
        justify-content:flex-end;
        gap:10px;
        background:#fafafa;
    }
    .btn{
        border:1px solid #ccc;
        background:#fff;
        padding: 8px 14px;
        border-radius: 6px;
        cursor:pointer;
        font-size: 13px;
        font-weight:bold;
    }
    .btn-primary{
        background:#93c02d;
        color:#fff;
        border:none;
    }
    .btn-primary:disabled{
        opacity:.5;
        cursor:not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<article class="shop-container">

    <div class="header-upper-row">
        <div><span class="official-label">å…¬å¼</span></div>
       <div class="action-buttons">

    <button class="btn-action" type="button">è¡Œã£ãŸ</button>

    <!-- âœ… ä¿å­˜ï¼šPOSTã§ä¿å­˜ãƒªã‚¹ãƒˆï¼†Reservation(ä¿å­˜æ¸ˆã¿)ã‚’ä½œã‚‹ -->
    <form method="post" action="{% url 'reviews:customer_review_list' %}" style="margin:0;">
     {% csrf_token %}
     <input type="hidden" name="action" value="save_store">
     <input type="hidden" name="store_id" value="{{ shop.id }}">
     <button class="btn-action" type="submit">
        {% if is_saved %}ä¿å­˜æ¸ˆã¿{% else %}ä¿å­˜{% endif %}
    </button>
    </form>


    <!-- âœ… æŠ•ç¨¿ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼‰ -->
            <button id="openPostModal" class="btn-action btn-post" type="button">æŠ•ç¨¿</button>

</div>

    </div>

    <div class="shop-main-info">
        <p class="catchphrase">{{ shop.catchphrase|default:"ç„¼è‚‰ã¨å¤šå›½ç±æ–™ç†ã‚’æº€å–«ï¼ç„¼é…ã‚«ã‚¯ãƒ†ãƒ«ã‚‚â—" }}</p>
        <h1 class="shop-title">{{ shop.name|default:"ç„¼è‚‰ã‚·ãƒ§ãƒƒãƒ—ã¾ã‚“ã¡ã„2 å­¦èŠ¸å¤§å­¦" }}</h1>

        <div class="rating-flex">
            <div class="star-rating" style="--rating-percent: {% widthratio shop.rating|default:3.07 5 100 %}%">
                <div class="star-rating-front">â˜…â˜…â˜…â˜…â˜…</div>
                <div class="star-rating-back">â˜…â˜…â˜…â˜…â˜…</div>
            </div>
            <span class="score-red">{{ shop.rating|default:3.07 }}</span>
            <span style="color: #06c; font-size: 13px;">{{ shop.review_count|default:13 }}äºº</span>
            <span style="color: #666; font-size: 13px;">{{ shop.save_count|default:903 }}äºº</span>
        </div>
    </div>

    <div class="shop-specs">
        <div class="spec-item">
            <span class="spec-label">æœ€å¯„ã‚Šé§…ï¼š</span>
            <span>{{ shop.station|default:"å­¦èŠ¸å¤§å­¦é§…" }} [{{ shop.area|default:"æ±äº¬" }}]</span>
        </div>
        <div class="spec-item">
            <span class="spec-label">ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</span>
            <span>{{ shop.genres|join:"ã€"|default:"ç„¼è‚‰ã€ãƒ›ãƒ«ãƒ¢ãƒ³ã€å†·éºº" }}</span>
        </div>
        <div class="spec-row">
            <div>
                <span class="spec-label">äºˆç®—ï¼š</span>
                <span>å¤œï¼š{{ shop.budget_night|default:"ï¿¥5,000ï½ï¿¥5,999" }} / æ˜¼ï¼š{{ shop.budget_day|default:"-" }}</span>
            </div>
            <a href="#" class="detail-link">åº—èˆ—æƒ…å ±ï¼ˆè©³ç´°ï¼‰</a>
        </div>
    </div>

    <nav class="shop-tabs">
        <a href="#" class="tab-item">ãƒˆãƒƒãƒ—</a>
        <a href="#" class="tab-item">åº§å¸­</a>
        <a href="#" class="tab-item">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚³ãƒ¼ã‚¹</a>
        <a href="#" class="tab-item">å†™çœŸ <span class="count-badge">87</span></a>
        <a href="{% url 'reviews:customer_reviewer_review_list' %}" class="tab-item active">å£ã‚³ãƒŸ <span class="count-badge">13</span></a>
        <a href="#" class="tab-item" style="color: #e60012;">ã‚¯ãƒ¼ãƒãƒ³ãƒ»åœ°å›³</a>
    </nav>

    <section class="review-filter-section">
        <div class="search-box-container">
            <label for="review-search" class="search-label">å£ã‚³ãƒŸæ¤œç´¢</label>
            <input type="text" id="review-search" class="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
            <button class="search-button">æ¤œç´¢</button>
        </div>

        <div class="filter-tabs">
            <a href="#" class="filter-tab-item active">ğŸ’¬ ã™ã¹ã¦ã®å£ã‚³ãƒŸ</a>
            <a href="#" class="filter-tab-item">ğŸŒ™ å¤œã®å£ã‚³ãƒŸ</a>
            <a href="#" class="filter-tab-item">â˜€ï¸ æ˜¼ã®å£ã‚³ãƒŸ</a>
        </div>

        <div class="sort-bar">
            <div class="sort-links">
                <span class="current-sort">æ¨™æº–</span>
                <a href="#" style="color: #06c; text-decoration: none; margin-left:10px;">è¨ªå•æœˆé †</a>
                <a href="#" style="color: #06c; text-decoration: none; margin-left:10px;">ã„ã„ã­ï¼é †</a>
            </div>
            
            <div class="list-header-info">
                <div><strong>1ï½20</strong> ä»¶ã‚’è¡¨ç¤º ï¼ å…¨ <strong>{{ shop.review_count|default:306 }}</strong> ä»¶</div>
                <div>
                    <label for="display-count" style="font-size: 12px;">è¡¨ç¤ºä»¶æ•°ï¼š</label>
                    <select id="display-count" name="per_page" style="font-size: 12px;">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select> ä»¶
                </div>
            </div>
        </div>
    </section>

    <section class="review-section">
        <div id="review-container">
            <article class="review-card">
                <div class="review-user-info">
                    <img src="https://via.placeholder.com/40" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼" width="40" height="40" class="user-avatar">
                    <div>
                        <div style="font-weight: bold;">{{ review.user_name|default:"å¤§å­¦ç”Ÿã®è´…æ²¢" }}</div>
                        <div style="font-size: 12px; color: #666;">å£ã‚³ãƒŸ363ä»¶ | ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼3485äºº</div>
                    </div>
                </div>
                <div style="color: #ffc107;">
                    â˜…â˜…â˜…â˜…â˜… <span style="color: #e60012; font-weight: bold;">{{ review.rating|default:"3.5" }}</span>
                </div>
                <p class="review-title">{{ review.title|default:"ã€Œèˆè¸Šã‚‹ç‰›ã‚¿ãƒ³ ï½å‡ºæ±ãŒå¥ã§ã‚‹ä¸€æœŸä¸€ä¼šã®ã‚·ãƒ³ãƒ•ã‚©ãƒ‹ãƒ¼ï½ã€" }}</p>
                <p style="font-size: 14px; line-height: 1.6;">{{ review.content|default:"è·äººã®æ‰‹ä»•äº‹ã«ã‚ˆã‚‹é€æ˜æ„Ÿã®ã‚ã‚‹è–„ã•ã«ã€æ€ã‚ãšè¦‹ã¨ã‚Œã¦ã—ã¾ã†ã€‚..." }}</p>
                <a href="#" style="color: #06c; text-decoration: none; font-size: 14px;">ã‚‚ã£ã¨è¦‹ã‚‹ âˆ¨</a>
            </article>
        </div>
    </section>

</article>

<!-- ==========================
     æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¿½åŠ ï¼‰
========================== -->
<div id="postModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-label="å£ã‚³ãƒŸæŠ•ç¨¿">
    <div class="modal-head">
      <div class="modal-title">å£ã‚³ãƒŸã‚’æŠ•ç¨¿</div>
      <button id="closePostModal" class="modal-close" type="button">Ã—</button>
    </div>

    <form id="reviewPostForm" method="post" action="{% url 'reviews:customer_review_list' %}">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_review">
      <input type="hidden" name="store_id" value="{{ shop.id }}">
      <input type="hidden" name="time_slot" id="timeSlotInput" value="">
      <input type="hidden" name="score" id="scoreInput" value="">

      <div class="modal-body">
        <div class="field">
          <span class="label">æ™‚é–“å¸¯</span>
          <div class="time-slot">
            <button type="button" class="slot-btn" data-slot="æ˜¼">â˜€ æ˜¼</button>
            <button type="button" class="slot-btn" data-slot="å¤œ">ğŸŒ™ å¤œ</button>
          </div>
        </div>

        <div class="field">
          <span class="label">è©•ä¾¡</span>
          <div class="stars" id="stars">
            <span class="star" data-v="1">â˜…</span>
            <span class="star" data-v="2">â˜…</span>
            <span class="star" data-v="3">â˜…</span>
            <span class="star" data-v="4">â˜…</span>
            <span class="star" data-v="5">â˜…</span>
            <span class="score-badge" id="scoreBadge">æœªé¸æŠ</span>
          </div>
        </div>

        <div class="field">
          <label class="label" for="reviewTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="reviewTitle" class="text-input" type="text" name="title" maxlength="100" placeholder="ä¾‹ï¼‰ã¾ãŸè¡ŒããŸã„ï¼">
        </div>

        <div class="field">
          <label class="label" for="reviewBody">æœ¬æ–‡</label>
          <textarea id="reviewBody" class="text-area" name="body" placeholder="æ–™ç†ãƒ»æ¥å®¢ãƒ»é›°å›²æ°—ãªã©è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„"></textarea>
        </div>

        <div class="agree-row">
          <input id="agreeCheck" type="checkbox" name="agree">
          <label for="agreeCheck">
            å†…å®¹ã«åŒæ„ã—ã¦æŠ•ç¨¿ã—ã¾ã™ï¼ˆèª¹è¬—ä¸­å‚·ãƒ»å€‹äººæƒ…å ±ã®æŠ•ç¨¿ã¯ã—ã¾ã›ã‚“ï¼‰
          </label>
        </div>
      </div>

      <div class="modal-foot">
        <button id="cancelBtn" class="btn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="submitBtn" class="btn btn-primary" type="submit" disabled>åŒæ„ã—ã¦æŠ•ç¨¿</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById("postModal");
  const openBtn = document.getElementById("openPostModal");
  const closeBtn = document.getElementById("closePostModal");
  const cancelBtn = document.getElementById("cancelBtn");

  const slotBtns = modal.querySelectorAll(".slot-btn");
  const timeSlotInput = document.getElementById("timeSlotInput");

  const starsWrap = document.getElementById("stars");
  const stars = starsWrap.querySelectorAll(".star");
  const scoreInput = document.getElementById("scoreInput");
  const scoreBadge = document.getElementById("scoreBadge");

  const agree = document.getElementById("agreeCheck");
  const submitBtn = document.getElementById("submitBtn");

  function openModal(){
    modal.classList.add("active");
    modal.setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    modal.classList.remove("active");
    modal.setAttribute("aria-hidden", "true");
  }

  function updateSubmitState(){
    const okAgree = agree.checked;
    const okSlot = timeSlotInput.value === "æ˜¼" || timeSlotInput.value === "å¤œ";
    const okScore = Number(scoreInput.value || "0") >= 1;
    submitBtn.disabled = !(okAgree && okSlot && okScore);
  }

  openBtn.addEventListener("click", openModal);
  closeBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);

  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  modal.addEventListener("click", (e) => {
    if(e.target === modal) closeModal();
  });

  // æ˜¼/å¤œ
  slotBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      slotBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      timeSlotInput.value = btn.dataset.slot;
      updateSubmitState();
    });
  });

  // æ˜Ÿ
  function paintStars(v){
    stars.forEach(s => {
      const sv = Number(s.dataset.v);
      s.classList.toggle("filled", sv <= v);
    });
    scoreBadge.textContent = v ? (v + " / 5") : "æœªé¸æŠ";
  }

  stars.forEach(s => {
    s.addEventListener("click", () => {
      const v = Number(s.dataset.v);
      scoreInput.value = String(v);
      paintStars(v);
      updateSubmitState();
    });
    s.addEventListener("mouseenter", () => {
      const v = Number(s.dataset.v);
      paintStars(v);
    });
  });

  starsWrap.addEventListener("mouseleave", () => {
    const v = Number(scoreInput.value || "0");
    paintStars(v);
  });

  agree.addEventListener("change", updateSubmitState);

  // åˆæœŸåŒ–
  paintStars(0);
  updateSubmitState();
})();
</script>
{% endblock %}