{% extends "customer_base.html" %}

{% block title %}å£ã‚³ãƒŸä¸€è¦§ - {{ shop.store_name }}{% endblock %}
{% block breadcrumb %}
<nav class="breadcrumbs">
  <ol>
    <li><a href="{% url 'accounts:customer_top' %}">ãƒˆãƒƒãƒ—</a></li>
    {% if from_search %}
      <li><a href="{% url 'search:customer_search_list' %}?from_search=1{% if keyword %}&keyword={{ keyword|urlencode }}{% endif %}{% if area %}&area={{ area|urlencode }}{% endif %}{% if date %}&date={{ date|urlencode }}{% endif %}{% if time %}&time={{ time|urlencode }}{% endif %}{% if sort %}&sort={{ sort|urlencode }}{% endif %}">{% if keyword %}{{ keyword }}{% elif area %}{{ area }}{% else %}æ¤œç´¢çµæœ{% endif %}</a></li>
    {% else %}
      <li><a href="{% url 'search:customer_search_list' %}?keyword={{ store.scene.scene_name }}">{{ store.scene.scene_name }}</a></li>
    {% endif %}
    <li><a href="{% url 'stores:customer_store_info' store.pk %}?from_search=1{% if keyword %}&keyword={{ keyword|urlencode }}{% endif %}{% if area %}&area={{ area|urlencode }}{% endif %}{% if date %}&date={{ date|urlencode }}{% endif %}{% if time %}&time={{ time|urlencode }}{% endif %}{% if sort %}&sort={{ sort|urlencode }}{% endif %}">{{ store.store_name }}</a></li>
    <li><span>å£ã‚³ãƒŸä¸€è¦§</span></li>
  </ol>
</nav>
{% endblock %}

{% block css %}
<style>
/* ===============================
   ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸å°‚ç”¨
================================ */
.shop-main{
  max-width:1000px;
  margin:0 auto;
  background:#fff;
  border:1px solid #e6e6e6;
  color:#333;
  font-family:"Hiragino Kaku Gothic ProN","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
}

/* ---- ãƒ¬ãƒ“ãƒ¥ãƒ¼éƒ¨åˆ†ãƒ©ãƒƒãƒ‘ ---- */
.review-wrapper{
  padding: 20px;
  margin:0 auto 40px;
}

/* ---------- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ ---------- */
.review-filter{
  background:#f9f9f7;
  border:1px solid #ddd;
  padding:20px;
  margin-bottom:20px;
}

.review-search{
  display:flex;
  gap:10px;
  margin-bottom:16px;
}

.review-search input{
  flex:1;
  padding:8px;
  border:1px solid #ccc;
  border-radius:4px;
}

.review-search button{
  background:#8fb134;
  color:#fff;
  border:none;
  padding:8px 24px;
  border-radius:4px;
  font-weight:bold;
  cursor:pointer;
}

/* ---------- ä»¶æ•° ---------- */
.review-count-row{
  font-size:12px;
  color:#666;
  margin-bottom:12px;
}

/* ---------- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ ---------- */
.review-card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:8px;
  padding:20px;
  margin-bottom:20px;
}

.review-user{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:12px;
}

.review-avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  background:#ddd;
}

.review-user-name{
  font-weight:bold;
}

.review-date{
  font-size:12px;
  color:#666;
}

/* --- ç‚¹æ•°è¡¨ç¤º --- */
.review-score{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.review-score .value{
  font-weight:bold;
  color:#e60012;
}

/* --- æœ¬æ–‡ --- */
.review-text{
  font-size:14px;
  line-height:1.7;
}

/* ===============================
   â˜… å£ã‚³ãƒŸå†™çœŸ
================================ */
.review-photos{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}

.review-photos a{
  display:block;
}

.review-photo{
  width:110px;
  height:110px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #eee;
  background:#fafafa;
  transition:transform .12s ease;
}

.review-photos a:hover .review-photo{
  transform:scale(1.03);
}

.review-photos-empty{
  margin-top:10px;
  font-size:12px;
  color:#999;
}

/* ===============================
   ğŸŒŸ ã„ã„ã­ï¼ ï¼† é€šå ±ã‚¨ãƒªã‚¢ï¼ˆè¿½åŠ ï¼‰
================================ */
.review-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dotted #eee;
}

/* ã„ã„ã­ï¼ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-like {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 20px;
  padding: 6px 16px;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  color: #666;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: 0.2s;
}

.btn-like:hover {
  background: #f9f9f9;
  border-color: #999;
}

.btn-like.is-active {
  color: #e91e63;
  border-color: #e91e63;
  background-color: #fff5f8;
}

.report-link{
  font-size:12px;
  color:#999;
  text-decoration:none;
}
.report-link:hover{
  color:#d9534f;
  text-decoration:underline;
}
</style>
{% endblock %}

{% block content %}
<div class="shop-main">

  {% include "stores/_customer_store_common.html" with store=store is_saved=is_saved star_states=star_states avg_rating=avg_rating review_count=review_count active_main="reviews" active_sub="top" %}

  <div class="review-wrapper">
 
    <section class="review-filter">
      <form class="review-search" method="get">
        <input type="hidden" name="store_id" value="{{ store_id }}">
        {# ä»–ã®æ¤œç´¢æ¡ä»¶ã‚‚ç¶­æŒã—ãŸã„å ´åˆã¯hiddenã‚’è¿½åŠ  #}
        {% if from_search %}<input type="hidden" name="from_search" value="{{ from_search }}">{% endif %}
        {% if keyword %}<input type="hidden" name="keyword" value="{{ keyword }}">{% endif %}
        {% if area %}<input type="hidden" name="area" value="{{ area }}">{% endif %}
        {% if date %}<input type="hidden" name="date" value="{{ date }}">{% endif %}
        {% if time %}<input type="hidden" name="time" value="{{ time }}">{% endif %}
        {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}

        <input type="text" name="review_keyword" value="{{ review_keyword }}" placeholder="å£ã‚³ãƒŸã‚’æ¤œç´¢">
        <button type="submit">æ¤œç´¢</button>
      </form>

      <div class="review-count-row">
        å…¨ <strong>{{ reviews.count }}</strong> ä»¶ã®å£ã‚³ãƒŸ
      </div>
    </section>

    {% for review in reviews %}
      <article class="review-card">

        <div class="review-user">
          <div class="review-avatar"></div>
          <div>
            <div class="review-user-name">
              {{ review.reviewer.nickname }} ã•ã‚“
            </div>
            <div class="review-date">
              æŠ•ç¨¿æ—¥ï¼š{{ review.posted_at|date:"Y/m/d" }}
            </div>
          </div>
        </div>

        <div class="review-score">
          <div class="value">{{ review.score|floatformat:1 }}</div>
          <div>/ 5.0</div>
        </div>

        <div class="review-text">
          {{ review.review_text|linebreaksbr }}
        </div>

        {% if review.photos.all %}
          <div class="review-photos">
            {% for photo in review.photos.all %}
              {% if photo.image_path %}
                <a href="{{ photo.image_path.url }}" target="_blank" rel="noopener">
                  <img class="review-photo" src="{{ photo.image_path.url }}" alt="å£ã‚³ãƒŸå†™çœŸ">
                </a>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="review-photos-empty">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>
        {% endif %}

        <!-- ğŸŒŸ è¿½è¨˜ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ï¼ˆã„ã„ã­ & é€šå ±ï¼‰ -->
        <div class="review-footer">
          <!-- ã„ã„ã­ï¼ãƒœã‚¿ãƒ³ -->
          <!-- è‡ªåˆ†ãŒã„ã„ã­æ¸ˆã¿ãªã‚‰ is-active ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã—ã¾ã™ -->
          <button type="button" 
                  class="btn-like {% if user in review.liked_users.all %}is-active{% endif %}" 
                  onclick="toggleLike(this, {{ review.pk }})">
            <span style="font-size: 16px;">â™¥</span>
            ã„ã„ã­ï¼ <span class="like-count">{{ review.like_count }}</span>
          </button>

          <!-- é€šå ±ãƒªãƒ³ã‚¯ -->
          <div class="report-wrap">
            <a href="{% url 'reviews:customer_report_input' %}?review_id={{ review.pk }}"
               class="report-link">
              ğŸš© ã“ã®å£ã‚³ãƒŸã‚’é€šå ±ã™ã‚‹
            </a>
          </div>
        </div>

      </article>
    {% empty %}
      <p style="text-align:center; color:#999; padding:40px;">
        ã¾ã å£ã‚³ãƒŸã¯æŠ•ç¨¿ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
      </p>
    {% endfor %}

  </div>
</div>

<!-- ğŸŒŸ è¿½è¨˜ï¼šJavaScriptãƒ­ã‚¸ãƒƒã‚¯ -->
<script>
async function toggleLike(button, reviewId) {
    // urls.py ã§è¨­å®šã—ãŸ toggle_review_like ã®ãƒ‘ã‚¹
    const url = `/reviews/review/like/${reviewId}/`;
    
    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        
        const data = await response.json();
        
        if (data.error === 'login_required') {
            alert("ã„ã„ã­ã‚’ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
            window.location.href = "{% url 'accounts:customer_login' %}";
            return;
        }

        // æ•°å€¤ã¨è¦‹ãŸç›®ã®æ›´æ–°
        const countSpan = button.querySelector('.like-count');
        countSpan.innerText = data.total_likes;
        button.classList.toggle('is-active', data.liked);
        
    } catch (error) {
        console.error("Error:", error);
    }
}
</script>
{% endblock %}