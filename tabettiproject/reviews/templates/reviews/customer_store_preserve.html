{% extends "customer_base.html" %}
{% load static %}

{% block title %}保存リスト{% endblock %}

{% block css %}
<style>
  .page-wrap {
    max-width: 980px;
    margin: 0 auto;
    padding: 18px 12px 60px;
    font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    color: #333;
  }

  .content-grid {
    display: flex;
    gap: 18px;
  }

  /* 左カラム */
  .side {
    width: 260px;
    flex: 0 0 260px;
  }

  .side-box {
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    margin-bottom: 14px;
    overflow: hidden;
  }

  .side-box h3 {
    margin: 0;
    font-size: 13px;
    font-weight: bold;
    padding: 10px 12px;
    background: #f7f3ea;
    border-bottom: 1px solid #e5e5e5;
  }

  .side-link {
    display: block;
    padding: 10px 12px;
    font-size: 12px;
    color: #06c;
    text-decoration: none;
    border-top: 1px solid #eee;
  }

  .side-link:hover {
    background: #fafafa;
  }

  .side-link.active {
    background: #79a52c;
    color: #fff;
    font-weight: bold;
  }

  .side-box .inner {
    padding: 12px;
    font-size: 12px;
    color: #555;
  }

  .side-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin: 8px 0;
  }

  .side-row select,
  .side-row input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 12px;
  }

  .btn-green {
    width: 100%;
    background: #79a52c;
    color: #fff;
    border: none;
    border-radius: 3px;
    padding: 10px 0;
    font-weight: bold;
    cursor: pointer;
    font-size: 13px;
  }

  .btn-outline {
    width: 100%;
    background: #fff;
    color: #06c;
    border: 1px solid #cfd8e6;
    border-radius: 3px;
    padding: 9px 0;
    font-weight: bold;
    cursor: pointer;
    font-size: 12px;
    margin-top: 8px;
  }

  /* 右カラム */
  .main {
    flex: 1;
    min-width: 0;
  }

  .main-title {
    font-size: 18px;
    font-weight: bold;
    margin: 6px 0 10px;
  }

  .main-note {
    font-size: 12px;
    color: #666;
    margin-bottom: 14px;
  }

  .main-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 10px;
    margin-bottom: 12px;
  }

  .sort-row {
    font-size: 12px;
    color: #666;
    display: flex;
    gap: 14px;
    align-items: center;
    margin-bottom: 14px;
  }

  .sort-row a {
    color: #06c;
    text-decoration: none;
  }

  .empty {
    border: 1px solid #eee;
    background: #fff;
    padding: 36px 18px;
    text-align: center;
    color: #666;
    border-radius: 4px;
  }

  .empty strong {
    display: block;
    font-size: 13px;
    color: #333;
    margin-bottom: 8px;
  }

  .preserve-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .preserve-card {
    border: 1px solid #e5e5e5;
    background: #fff;
    border-radius: 4px;
    padding: 12px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
  }

  .preserve-name {
    font-weight: bold;
    margin-bottom: 6px;
  }

  .preserve-meta {
    font-size: 12px;
    color: #666;
    line-height: 1.5;
  }

  /* 追加：保存解除ボタン */
  .btn-remove {
    background: #fff;
    border: 1px solid #d6d6d6;
    color: #666;
    border-radius: 3px;
    padding: 8px 10px;
    font-size: 12px;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-remove:hover {
    background: #fafafa;
  }
</style>
{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumbs">
  <ol>
    <li><a href="{% url 'accounts:customer_top' %}">トップ</a></li>
    <li><span>保存済みのお店</span></li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="page-wrap">
  <div class="content-grid">

    <!-- 左：絞り込み -->
    <aside class="side">
      <form method="get" action="{% url 'reviews:customer_store_preserve' %}">
        <div class="side-box">
          <h3>ジャンルから探す</h3>
          <a class="side-link {% if not selected_genre or selected_genre == 'all' %}active{% endif %}" 
             href="{% url 'reviews:customer_store_preserve' %}?genre=all&min_budget={{ selected_min|default:'' }}&max_budget={{ selected_max|default:'' }}&went={{ selected_went|default:'any' }}">
            ・すべて
          </a>
          {% for g in genres %}
            <a class="side-link {% if selected_genre == g.id|stringformat:'s' %}active{% endif %}" 
               href="{% url 'reviews:customer_store_preserve' %}?genre={{ g.id }}&min_budget={{ selected_min|default:'' }}&max_budget={{ selected_max|default:'' }}&went={{ selected_went|default:'any' }}">
              ・{{ g.name }}
            </a>
            {% if selected_genre == g.id|stringformat:'s' %}
              <input type="hidden" name="genre" value="{{ g.id }}">
            {% endif %}
          {% endfor %}
          {% if not selected_genre or selected_genre == 'all' %}
            <input type="hidden" name="genre" value="all">
          {% endif %}
        </div>

        <div class="side-box">
          <h3>保存検索</h3>
          <div class="inner">
            <div class="side-row">
              <label style="width:48px;">下限</label>
              <select name="min_budget">
                <option value="">下限なし</option>
                {% for price in budget_choices %}
                  <option value="{{ price }}" {% if selected_min == price|stringformat:'s' %}selected{% endif %}>{{ price }}円</option>
                {% endfor %}
              </select>
            </div>
            <div class="side-row">
              <label style="width:48px;">上限</label>
              <select name="max_budget">
                <option value="">上限なし</option>
                {% for price in budget_choices %}
                  <option value="{{ price }}" {% if selected_max == price|stringformat:'s' %}selected{% endif %}>{{ price }}円</option>
                {% endfor %}
              </select>
            </div>

            <div style="margin-top:10px; font-weight:bold; font-size:12px;">行った・行ってない</div>
            <div class="side-row">
              <input type="radio" name="went" id="went_any" value="any" {% if selected_went == 'any' or not selected_went %}checked{% endif %}>
              <label for="went_any">指定なし</label>
            </div>
            <div class="side-row">
              <input type="radio" name="went" id="went_yes" value="yes" {% if selected_went == 'yes' %}checked{% endif %}>
              <label for="went_yes">行った</label>
            </div>
            <div class="side-row">
              <input type="radio" name="went" id="went_no" value="no" {% if selected_went == 'no' %}checked{% endif %}>
              <label for="went_no">行ってない</label>
            </div>

            <button class="btn-green" type="submit" style="margin-top: 15px;">絞り込む</button>
            <a href="{% url 'reviews:customer_store_preserve' %}" class="btn-outline" style="display:block; text-align:center; text-decoration:none; margin-top:8px; line-height:30px;">
              クリア
            </a>
          </div>
        </div>
      </form>
    </aside>

    <!-- 右：保存リスト -->
    <main class="main">
      <div class="main-head">
        <div>
          <div class="main-title">保存リスト</div>
          <div class="main-note">
            「保存リスト」では、検索結果やお店のページなどから保存したお店を管理することができます。
          </div>
        </div>
      </div>

      <div class="sort-row">
        <span>↑↓</span>
        <strong>保存日時</strong>
        <a href="#">ランキング順</a>
        <a href="#">食べログ総合ランキング</a>
      </div>

      {% if saved_list and saved_list|length > 0 %}
      <div class="preserve-list">
        {% for r in saved_list %}
        <div class="preserve-card">
          <div>
            <div class="preserve-name">
              <a href="{% url 'stores:customer_store_info' r.store.pk %}" style="color: #06c; text-decoration: none;">
                {{ r.store.store_name }} {{ r.store.branch_name }}
              </a>
            </div>
            <div class="preserve-meta">
              保存日時：{{ r.created_at|date:"Y/m/d H:i" }}<br>
              エリア：{{ r.store.area.area_name }} ／ シーン：{{ r.store.scene.scene_name }}<br>
              住所：{{ r.store.address }}
            </div>
          </div>

          <!-- ✅ 保存解除ボタン -->
          <form method="post" action="{% url 'reviews:customer_store_preserve' %}" style="margin:0;">
            {% csrf_token %}
            <input type="hidden" name="action" value="remove_store">
            <input type="hidden" name="reservation_id" value="{{ r.id }}">
            <button type="submit" class="btn-remove" onclick="return confirm('保存解除しますか？');">
              保存解除
            </button>
          </form>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty">
        <strong>保存リストのお店はありません。</strong>
        <div>検索結果やお店のページなどから保存したお店を管理することができます。</div>
      </div>
      {% endif %}

    </main>

  </div>
</div>
{% endblock %}