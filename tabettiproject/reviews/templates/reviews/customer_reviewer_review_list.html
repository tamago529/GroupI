{% extends 'customer_base.html' %}
{% load static %}

{% block title %}{{ user_name }}ã•ã‚“ã®å£ã‚³ãƒŸæŠ•ç¨¿ã—ãŸãŠåº— [ã‚¿ãƒ™ãƒƒãƒ]{% endblock %}

{% block css %}
<style>
  /* -----------------------------------------------------------
       1. å…¨ä½“èƒŒæ™¯ã¨åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    ----------------------------------------------------------- */
  body {
    background-color: #f4f4f2 !important;
    margin: 0;
    color: #333;
    font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
  }

  .tabelog-container {
    max-width: 980px;
    margin: 0 auto;
    padding-top: 15px;
  }

  .columns-flex {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  /* -----------------------------------------------------------
       2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼
    ----------------------------------------------------------- */
  .user-header-unit {
    background: #fff;
    border: 1px solid #e6e6e2;
    margin-bottom: 15px;
    position: relative;
  }

  .cover-wallpaper {
    height: 145px;
    background: #ccc url('https://placehold.jp/980x145.png?text=User%20Cover%20Image') no-repeat center;
    background-size: cover;
    position: relative;
  }

  .sub-id-in-cover {
    position: absolute;
    left: 145px;
    bottom: 15px;
    color: #fff;
    font-size: 15px;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  }

  .btn-action {
    background: #fff;
    border: 1px solid #ccc;
    padding: 5px 15px;
    font-size: 12px;
    font-weight: bold;
    border-radius: 2px;
    cursor: pointer;
  }

  /* å£ã‚³ãƒŸæŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’ç·‘ */
  .btn-action.btn-green {
    background: #82c00e;
    border-color: #6a9c0b;
    color: #fff;
    box-shadow: 0 2px 0 #6a9c0b;
  }

  .btn-action.btn-green:hover {
    filter: brightness(0.98);
  }

  /* æŠ•ç¨¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’å·¦æƒãˆã§æ•´ãˆã‚‹ */
  .review-text {
    font-size: 13px;
    margin-top: 8px;
    white-space: normal;
    /* é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã¯æ½°ã™ */
    text-align: left;
    line-height: 1.6;
  }


  .user-icon-box {
    position: absolute;
    left: 20px;
    bottom: 15px;
    width: 110px;
    height: 110px;
    background: #fff;
    border: 1px solid #e6e6e2;
    padding: 4px;
    border-radius: 4px;
    z-index: 10;
  }

  .profile-info-nav-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 145px;
    padding-right: 15px;
    min-height: 60px;
  }

  .main-nick {
    font-size: 20px;
    font-weight: bold;
    margin: 0;
  }

  .mypage-tabs {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .mypage-tabs li a {
    display: block;
    padding: 20px 15px;
    font-size: 13px;
    font-weight: bold;
    color: #06c;
    text-decoration: none;
    border-bottom: 3px solid transparent;
  }

  .mypage-tabs li a.active {
    color: #333 !important;
    border-bottom: 3px solid #66635c;
  }

  /* -----------------------------------------------------------
       3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚¨ãƒªã‚¢ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ãƒ»è©³ç´°æ¤œç´¢ï¼‰
    ----------------------------------------------------------- */
  .side-col {
    width: 210px;
    flex-shrink: 0;
  }

  /* é¸æŠãƒœãƒƒã‚¯ã‚¹å…±é€š */
  .selection-box {
    background: #fff;
    border: 1px solid #e6e6e2;
    border-radius: 4px;
    margin-bottom: 10px;
    font-size: 13px;
  }

  .selection-box-head {
    padding: 10px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    background: #f9f9f7;
  }

  .selection-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 10px;
    text-decoration: none;
    color: #06c;
    border-bottom: 1px dotted #eee;
  }
  .selection-item:hover {
    background: #f9f9f7;
  }
  .selection-item-active {
    background: #fff9e6;
    border-left: 3px solid #ffa500;
    padding: 8px 10px;
    display: flex;
    justify-content: space-between;
    text-decoration: none;
    color: #333;
    font-weight: bold;
  }

  .map-view-link {
    display: block;
    padding: 8px 10px;
    color: #06c;
    font-size: 11px;
    text-decoration: none;
    border-top: 1px dotted #e6e6e2;
  }

  /* çµã‚Šè¾¼ã¿æ  */
  .filter-box {
    background: #fff;
    border: 1px solid #e6e6e2;
    border-radius: 4px;
    font-size: 12px;
    overflow: hidden;
  }

  .filter-section-label {
    background: #f9f9f7;
    padding: 5px 10px;
    font-weight: bold;
    border-bottom: 1px solid #e6e6e2;
    border-top: 1px solid #e6e6e2;
  }

  .filter-section-label:first-child {
    border-top: none;
  }

  .filter-group {
    padding: 10px;
  }

  .filter-group label {
    display: block;
    margin-bottom: 5px;
    cursor: pointer;
  }

  .btn-submit-green {
    width: 100%;
    background: #82c00e;
    color: #fff;
    border: none;
    padding: 8px;
    font-weight: bold;
    border-radius: 3px;
    cursor: pointer;
    box-shadow: 0 2px 0 #6a9c0b;
    margin-bottom: 10px;
  }

  /* å¤‰æ›´ç®‡æ‰€ï¼šè©³ç´°æ¤œç´¢ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .btn-detailed-search {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    width: 100%;
    background: linear-gradient(#ffffff, #f2f2f2);
    border: 1px solid #ccc;
    padding: 6px 0;
    font-size: 11px;
    font-weight: bold;
    color: #333;
    border-radius: 3px;
    text-decoration: none;
    box-sizing: border-box;
  }

  .btn-detailed-search:hover {
    background: #f9f9f9;
    border-color: #bbb;
  }

  .icon-paper {
    display: inline-block;
    width: 12px;
    height: 12px;
    background: #fff;
    border: 1px solid #bbb;
    position: relative;
    flex-shrink: 0;
  }

  .icon-paper::after {
    content: "";
    position: absolute;
    top: 3px;
    left: 2px;
    width: 8px;
    height: 1px;
    background: #ccc;
    box-shadow: 0 3px 0 #ccc, 0 6px 0 #ccc;
  }

  /* -----------------------------------------------------------
       4. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆä¸¦ã³æ›¿ãˆãƒ»æ³¨æ„æ›¸ãï¼‰
    ----------------------------------------------------------- */
  .main-col {
    flex-grow: 1;
  }

  .main-content-card {
    background: #fff;
    border: 1px solid #e6e6e2;
    padding: 20px;
  }

  .content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .sort-nav {
    border-bottom: 1px solid #e6e6e2;
    padding: 8px 0;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
  }

  .sort-list {
    display: flex;
    gap: 10px;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sort-list a {
    color: #06c;
    text-decoration: none;
  }

  .sort-list .active {
    color: #333;
    font-weight: bold;
    text-decoration: none;
  }

  .disclaimer-box {
    background: #f9f9f7;
    border: 1px solid #e6e6e2;
    padding: 12px;
    font-size: 11px;
    line-height: 1.6;
    color: #666;
    margin-bottom: 20px;
  }

  .icon-inline {
    vertical-align: middle;
  }

  .select-sm {
    width: 75px;
    padding: 2px;
    border: 1px solid #ccc;
    font-size: 12px;
  }

  /* ==========================
       å£ã‚³ãƒŸæŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ«
    ========================== */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .45);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 9999;
  }

  .modal-backdrop.active {
    display: flex;
  }

  .modal-card {
    width: 100%;
    max-width: 560px;
    background: #fff;
    border: 1px solid #e6e6e2;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, .2);
  }

  .modal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    background: #f9f9f7;
    border-bottom: 1px solid #e6e6e2;
  }

  .modal-title {
    font-weight: bold;
    font-size: 14px;
  }

  .modal-close {
    border: none;
    background: transparent;
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    color: #666;
  }

  .modal-body {
    padding: 14px;
  }

  .field {
    margin-bottom: 12px;
  }

  .label {
    display: block;
    font-size: 12px;
    font-weight: bold;
    color: #444;
    margin-bottom: 6px;
  }

  .text-input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    box-sizing: border-box;
  }

  .text-area {
    width: 100%;
    min-height: 120px;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    box-sizing: border-box;
    resize: vertical;
  }

  .time-slot {
    display: flex;
    gap: 8px;
  }

  .slot-btn {
    border: 1px solid #ccc;
    background: #fff;
    padding: 6px 10px;
    font-size: 12px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
  }

  .slot-btn.active {
    border-color: #66635c;
    background: #f4f4f2;
  }

  .stars {
    display: flex;
    align-items: center;
    gap: 4px;
    user-select: none;
  }

  .star {
    font-size: 20px;
    color: #ccc;
    cursor: pointer;
  }

  .star.filled {
    color: #f2b01e;
  }

  .score-badge {
    margin-left: 8px;
    font-size: 12px;
    color: #666;
    border: 1px solid #e6e6e2;
    padding: 2px 6px;
    border-radius: 999px;
    background: #fafafa;
  }

  .agree-row {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    font-size: 12px;
    color: #444;
    line-height: 1.5;
  }

  .agree-row input {
    margin-top: 2px;
  }

  .modal-foot {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 12px 14px;
    border-top: 1px solid #e6e6e2;
    background: #fff;
  }

  .btn {
    border: 1px solid #ccc;
    background: #fff;
    padding: 6px 12px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
  }

  .btn-primary {
    border-color: #6a9c0b;
    background: #82c00e;
    color: #fff;
  }

  .btn-primary:disabled {
    opacity: .5;
    cursor: not-allowed;
  }

  /* å£ã‚³ãƒŸã‚«ãƒ¼ãƒ‰å·¦å´ã‚’å…¨éƒ¨å·¦æƒãˆã«ï¼ˆå¼·åˆ¶ï¼‰ */
  .review-left {
    text-align: left !important;
  }

  .review-title {
    text-align: left !important;
  }

  .review-meta {
    text-align: left !important;
  }
</style>
{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumbs">
  <ol>
    <li><a href="{% url 'accounts:customer_top' %}">ãƒˆãƒƒãƒ—</a></li>
    <li><a href="{% if readonly_mode %}{% url 'follows:customer_user_page' customer.pk %}{% else %}{% url 'reviews:customer_reviewer_detail' %}{% endif %}">{{ user_name }}ã•ã‚“ã®ãƒšãƒ¼ã‚¸</a></li>
    <li><span>å£ã‚³ãƒŸæŠ•ç¨¿ä¸€è¦§</span></li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="tabelog-container">

  <header class="user-header-unit">
    <div class="cover-wallpaper"
      style="background-image:url('{% if cover_image_url %}{{ cover_image_url }}{% else %}{% static "
      images/default_cover.jpg" %}{% endif %}');">


      <div class="sub-id-in-cover">{{ customer.subtitle|default:"(ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š)" }}</div>
    </div>
    <div class="user-icon-box">
      <img src="{% if user_icon_url %}{{ user_icon_url }}{% else %}{% static 'images/default_icon.png' %}{% endif %}"
        alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³" width="110" height="110">
    </div>
    <div class="profile-info-nav-bar">
      <div class="name-set">
          <div class="nickname">{{ customer.nickname }} ã•ã‚“ã®ã‚¬ã‚¤ãƒ‰</div>
      </div>
      <nav>
        <ul class="mypage-tabs">
          <li><a href="{% if readonly_mode %}{% url 'follows:customer_user_page' customer.pk %}{% else %}{% url 'reviews:customer_reviewer_detail' %}{% endif %}">ãƒˆãƒƒãƒ—</a></li>
          <li><a href="#" class="active">å£ã‚³ãƒŸ</a></li>
          <li><a href="{% url 'follows:customer_follow_list' %}">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</a></li>
          <li><a href="{% url 'follows:customer_follower_list' %}">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="columns-flex">

    <aside class="side-col">

      <section class="selection-box">
        <div class="selection-box-head">ã‚¸ãƒ£ãƒ³ãƒ«<span>ğŸ´</span></div>
        <a href="?genre=all&min_budget={{ selected_min|default:'' }}&max_budget={{ selected_max|default:'' }}" 
           class="{% if not selected_genre or selected_genre == 'all' %}selection-item-active{% else %}selection-item{% endif %}">
          <span>ã™ã¹ã¦</span> <span>&gt;</span>
        </a>
        {% for g in genres %}
        <a href="?genre={{ g.id }}&min_budget={{ selected_min|default:'' }}&max_budget={{ selected_max|default:'' }}" 
           class="{% if selected_genre == g.id|stringformat:'s' %}selection-item-active{% else %}selection-item{% endif %}">
          <span>{{ g.name }}</span> <span>&gt;</span>
        </a>
        {% endfor %}
      </section>

      <div class="filter-box">
        <form action="" method="get">
          {% if selected_genre and selected_genre != 'all' %}
          <input type="hidden" name="genre" value="{{ selected_genre }}">
          {% endif %}

          <div class="filter-section-label">äºˆç®—</div>
          <div class="filter-group">
            <div style="display:flex; align-items:center; gap:3px;">
              <select name="min_budget" class="select-sm" aria-label="äºˆç®—ã®ä¸‹é™">
                <option value="">ä¸‹é™ãªã—</option>
                {% for b in budget_choices %}
                <option value="{{ b }}" {% if selected_min == b|stringformat:"s" %}selected{% endif %}>ï¿¥{{ b }}</option>
                {% endfor %}
              </select>
              <span>ã€œ</span>
              <select name="max_budget" class="select-sm" aria-label="äºˆç®—ã®ä¸Šé™">
                <option value="">ä¸Šé™ãªã—</option>
                {% for b in budget_choices %}
                <option value="{{ b }}" {% if selected_max == b|stringformat:"s" %}selected{% endif %}>ï¿¥{{ b }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="filter-group">
            <button type="submit" class="btn-submit-green">çµã‚Šè¾¼ã‚€</button>
            <a href="#" class="btn-detailed-search">
              <span class="icon-paper" aria-hidden="true"></span>
              ã‚‚ã£ã¨è©³ã—ã„æ¡ä»¶ã§æ¤œç´¢
            </a>
          </div>
        </form>
      </div>
    </aside>

    <main class="main-col">
      <div class="main-content-card">
        <div class="content-header">
          <h2 style="font-size: 18px; margin: 0;">å£ã‚³ãƒŸä¸€è¦§</h2>
          <a href="#" style="font-size: 12px; color: #06c; text-decoration: none;">
          </a>
        </div>

        <div style="font-size: 13px; margin: 15px 0 10px;">
          <strong>å…¨ {{ my_reviews_total }}</strong> ä»¶
        </div>

        {% if my_reviews_total > 0 %}
        {% for rv in my_reviews %}
        <article style="border-top:1px dotted #ccc; padding: 16px 0;">
          <div style="display:flex; justify-content:space-between; gap:12px;">

            <!-- å·¦å´ï¼šã‚¿ã‚¤ãƒˆãƒ«/æ™‚é–“å¸¯/æœ¬æ–‡ï¼ˆå…¨éƒ¨å·¦æƒãˆï¼‰ -->
            <div class="review-left" style="min-width:0;">
              <div class="review-title" style="font-weight:bold; font-size:15px;">
                <a href="{% url 'stores:customer_store_info' rv.store.pk %}" style="color: #06c; text-decoration: none;">
                  {{ rv.store.store_name }}{% if rv.store.branch_name %} {{ rv.store.branch_name }}{% endif %}
                </a>
                <span style="font-size:13px; color:#666; font-weight:normal; margin-left:8px;">
                  [äºˆç®—: ï¿¥{{ rv.store.budget }}]
                </span>
              </div>

              <div class="review-meta" style="font-size:12px; color:#666; margin-top:4px;">
                æŠ•ç¨¿æ—¥ï¼š{{ rv.posted_at|date:"Y/m/d H:i" }} ï¼ è©•ä¾¡ï¼š{{ rv.score }}
              </div>

              <div class="review-text">
                {{ rv.review_text|linebreaksbr }}
              </div>
            </div>

            <!-- å³å´ï¼šãƒœã‚¿ãƒ³ç¾¤ -->
            <div style="display:flex; gap:8px; align-items:flex-start; flex-shrink:0;">

              {% if not readonly_mode %}
              <!-- å£ã‚³ãƒŸã‚’æŠ•ç¨¿ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹•ï¼‰ -->
              <button type="button" class="btn-action btn-green openPostModal" style="white-space:nowrap;">
                å£ã‚³ãƒŸã‚’æŠ•ç¨¿
              </button>

              <!-- å‰Šé™¤ -->
              <form method="post" action="{% url 'reviews:customer_reviewer_review_list' %}" style="margin:0;">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_review">
                <input type="hidden" name="review_id" value="{{ rv.id }}">
                <button type="submit" class="btn-action" style="white-space:nowrap;"
                  onclick="return confirm('å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                  å‰Šé™¤
                </button>
              </form>
              {% endif %}

            </div>
          </div>
        </article>
        {% endfor %}
        {% else %}
        <div style="padding:20px; color:#666;">
          ã¾ã å£ã‚³ãƒŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        {% endif %}
      </div>
    </main>
  </div>
</div>

<!-- ==========================
     æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¿½åŠ ï¼‰
========================== -->
<div id="postModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-label="å£ã‚³ãƒŸæŠ•ç¨¿">
    <div class="modal-head">
      <div class="modal-title">å£ã‚³ãƒŸã‚’æŠ•ç¨¿</div>
      <button id="closePostModal" class="modal-close" type="button">Ã—</button>
    </div>

    <form id="reviewPostForm" method="post" action="{% url 'reviews:customer_reviewer_review_list' %}">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_review">
      <input type="hidden" name="score" id="scoreInput" value="">

      <div class="modal-body">

        <!-- åº—èˆ—é¸æŠï¼ˆè¿½åŠ ï¼‰ -->
        <div class="field">
          <label class="label" for="storeSelect">åº—èˆ—</label>
          <select id="storeSelect" name="store_id" class="text-input">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            {% for s in store_choices %}
            <option value="{{ s.id }}">{{ s.store_name }}{% if s.branch_name %} {{ s.branch_name }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>



        <div class="field">
          <span class="label">è©•ä¾¡</span>
          <div class="stars" id="stars">
            <span class="star" data-v="1">â˜…</span>
            <span class="star" data-v="2">â˜…</span>
            <span class="star" data-v="3">â˜…</span>
            <span class="star" data-v="4">â˜…</span>
            <span class="star" data-v="5">â˜…</span>
            <span class="score-badge" id="scoreBadge">æœªé¸æŠ</span>
          </div>
        </div>

        <div class="field">
          <label class="label" for="reviewTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="reviewTitle" class="text-input" type="text" name="title" maxlength="100" placeholder="ä¾‹ï¼‰ã¾ãŸè¡ŒããŸã„ï¼">
        </div>

        <div class="field">
          <label class="label" for="reviewBody">æœ¬æ–‡</label>
          <textarea id="reviewBody" class="text-area" name="body" placeholder="æ–™ç†ãƒ»æ¥å®¢ãƒ»é›°å›²æ°—ãªã©è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„"></textarea>
        </div>

        <div class="agree-row">
          <input id="agreeCheck" type="checkbox" name="agree">
          <label for="agreeCheck">
            å†…å®¹ã«åŒæ„ã—ã¦æŠ•ç¨¿ã—ã¾ã™ï¼ˆèª¹è¬—ä¸­å‚·ãƒ»å€‹äººæƒ…å ±ã®æŠ•ç¨¿ã¯ã—ã¾ã›ã‚“ï¼‰
          </label>
        </div>
      </div>

      <div class="modal-foot">
        <button id="cancelBtn" class="btn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="submitBtn" class="btn btn-primary" type="submit" disabled>åŒæ„ã—ã¦æŠ•ç¨¿</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const modal = document.getElementById("postModal");
    const closeBtn = document.getElementById("closePostModal");
    const cancelBtn = document.getElementById("cancelBtn");

    const storeSelect = document.getElementById("storeSelect");

    const starsWrap = document.getElementById("stars");
    const stars = starsWrap.querySelectorAll(".star");
    const scoreInput = document.getElementById("scoreInput");
    const scoreBadge = document.getElementById("scoreBadge");

    const agree = document.getElementById("agreeCheck");
    const submitBtn = document.getElementById("submitBtn");

    function openModal() {
      modal.classList.add("active");
      modal.setAttribute("aria-hidden", "false");
    }
    function closeModal() {
      modal.classList.remove("active");
      modal.setAttribute("aria-hidden", "true");
    }

    function updateSubmitState() {
      const okStore = !!(storeSelect && storeSelect.value);
      const okAgree = agree.checked;
      const okScore = Number(scoreInput.value || "0") >= 1;
      submitBtn.disabled = !(okStore && okAgree && okScore);
    }

    // è¤‡æ•°ã®ã€Œå£ã‚³ãƒŸã‚’æŠ•ç¨¿ã€ãƒœã‚¿ãƒ³ã«å¯¾å¿œ
    document.querySelectorAll(".openPostModal").forEach(btn => {
      btn.addEventListener("click", openModal);
    });

    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    if (storeSelect) {
      storeSelect.addEventListener("change", updateSubmitState);
    }



    function paintStars(v) {
      stars.forEach(s => {
        const sv = Number(s.dataset.v);
        s.classList.toggle("filled", sv <= v);
      });
      scoreBadge.textContent = v ? (v + " / 5") : "æœªé¸æŠ";
    }

    stars.forEach(s => {
      s.addEventListener("click", () => {
        const v = Number(s.dataset.v);
        scoreInput.value = String(v);
        paintStars(v);
        updateSubmitState();
      });
      s.addEventListener("mouseenter", () => {
        const v = Number(s.dataset.v);
        paintStars(v);
      });
    });

    starsWrap.addEventListener("mouseleave", () => {
      const v = Number(scoreInput.value || "0");
      paintStars(v);
    });

    agree.addEventListener("change", updateSubmitState);

    paintStars(0);
    updateSubmitState();
  })();
</script>

{% endblock %}